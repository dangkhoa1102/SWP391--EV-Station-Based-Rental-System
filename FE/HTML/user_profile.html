<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>User Profile - FEC</title>
    <link rel="stylesheet" href="../style.css" />
    <link rel="stylesheet" href="../CSS/shared.css" />
    <link rel="stylesheet" href="../CSS/user_profile.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="../api.js"></script>
</head>

<body>
    <header class="header">
        <div class="container header-container">
            <div class="logo">
                <a href="home_page.html">FEC</a>
            </div>
            <button class="mobile-menu-btn" onclick="toggleMobileMenu()">
                <i class="fas fa-bars"></i>
            </button>
            <nav class="nav">
                <div class="navbar-right">
                    <!-- Login button for non-authenticated users -->
                    <button id="loginBtn" onclick="openModal()" class="login-nav-btn" style="display:none;">Login</button>
                    
                    <!-- User menu for authenticated users -->
                    <div id="userMenu" class="user-menu" style="display: none;">
                        <button class="user-menu-btn" onclick="toggleUserMenu()">
                            <i class="fas fa-user-circle"></i>
                            <i class="fas fa-chevron-down"></i>
                        </button>
                        <div id="userDropdown" class="user-dropdown">
                            <div class="dropdown-header">
                                <i class="fas fa-user-circle"></i>
                                <span id="userEmail">User Account</span>
                            </div>
                            <hr>
                            <a href="booking_history.html" onclick="toggleUserMenu()">
                                <i class="fas fa-history"></i> Booking History
                            </a>
                            <a href="#" onclick="logout()">
                                <i class="fas fa-sign-out-alt"></i> Logout
                            </a>
                        </div>
                    </div>
                </div>
            </nav>
        </div>
    </header>

    <main>
        <div class="profile-container">
            <h2>USER PROFILE</h2>

            <div class="profile-field">
                <input type="text" id="username" placeholder="Username" value="JohnDoe" readonly>
            </div>

            <div class="profile-field">
                <input type="email" id="email" placeholder="Email" value="john.doe@example.com">
            </div>

            <div class="profile-field">
                <input type="tel" id="phone" placeholder="Phone Number" value="+1234567890">
            </div>

            <div class="document-upload">
                <label>Driver's License</label>
                <div class="document-upload-wrapper">
                    <input type="file" id="driver-license" accept="image/*">
                    <div class="document-placeholder">
                        driver_license.PNG
                    </div>
                    <button class="upload-btn" onclick="document.getElementById('driver-license').click()">Upload</button>
                </div>
            </div>

            <div class="document-upload">
                <label>ID Card</label>
                <div class="document-upload-wrapper">
                    <input type="file" id="id-card" accept="image/*">
                    <div class="document-placeholder">
                        ID_card.PNG
                    </div>
                    <button class="upload-btn" onclick="document.getElementById('id-card').click()">Upload</button>
                </div>
            </div>

            <button class="change-password-btn" onclick="openChangePasswordModal()">Change Password</button>
        </div>
    </main>

    <!-- Change Password Modal -->
    <div id="changePasswordModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeChangePasswordModal()">&times;</span>
            <h2>Change Password</h2>
            <form id="changePasswordForm">
                <div class="form-group">
                    <div class="password-input-wrapper">
                        <input type="password" id="currentPassword" placeholder="Current Password" required>
                        <i class="fas fa-eye toggle-password" onclick="togglePasswordVisibility('currentPassword')"></i>
                    </div>
                </div>
                <div class="form-group">
                    <div class="password-input-wrapper">
                        <input type="password" id="newPassword" placeholder="New Password" required>
                        <i class="fas fa-eye toggle-password" onclick="togglePasswordVisibility('newPassword')"></i>
                    </div>
                    <small>Password must contain uppercase, lowercase, digit, and special character</small>
                </div>
                <div class="form-group">
                    <div class="password-input-wrapper">
                        <input type="password" id="confirmPassword" placeholder="Confirm New Password" required>
                        <i class="fas fa-eye toggle-password" onclick="togglePasswordVisibility('confirmPassword')"></i>
                    </div>
                </div>
                <button type="submit" class="btn-submit">Change Password</button>
            </form>
        </div>
    </div>

    <!-- Notification -->
    <div id="notification" class="notification"></div>

    <!-- Login Modal -->
    <div id="modal" class="modal-overlay">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal()">&times;</span>
            <h2>LOGIN</h2>
            <form id="loginForm">
                <input type="email" id="loginEmail" placeholder="Enter Email" required>
                <input type="password" id="loginPassword" placeholder="Enter Password" required>
                <a href="#">Forgot Password?</a>
                <button type="submit">Login</button>
                <a href="#" onclick="openRegisterModal()">Create Account</a>
            </form>
        </div>
    </div>

    <!-- Register Modal -->
    <div id="registerModal" class="modal-overlay">
        <div class="modal-content">
            <span class="close-btn" onclick="closeRegisterModal()">&times;</span>
            <h2>Register</h2>
            <form id="registerForm">
                <input type="text" id="registerUsername" placeholder="Username (min 3 characters)" required>
                <input type="email" id="registerEmail" placeholder="Email" required>
                <input type="tel" id="registerPhone" placeholder="Phone Number (10-11 digits)" required pattern="[0-9]{10,11}">
                <input type="password" id="registerPassword" placeholder="Password (A-Z, a-z, 0-9, special chars)" required minlength="6">
                <small class="password-hint">
                    Password must include: Uppercase, lowercase, number and special character
                </small>
                <button type="submit">Create Account</button>
            </form>
        </div>
    </div>

    <footer class="footer">
        <div class="container">
            <p>&copy; 2025 FEC. All rights reserved.</p>
        </div>
    </footer>

    <script src="../api.js"></script>
    <script>
        // ========== Auth Functions ==========
        function checkAuthStatus() {
            const token = localStorage.getItem('token');
            const loginBtn = document.getElementById('loginBtn');
            const userMenu = document.getElementById('userMenu');
            const userEmail = document.getElementById('userEmail');

            if (token && token !== 'null') {
                loginBtn.style.display = 'none';
                userMenu.style.display = 'block';
                userEmail.textContent = localStorage.getItem('userEmail') || 'User';
            } else {
                loginBtn.style.display = 'block';
                userMenu.style.display = 'none';
            }
        }

        function toggleUserMenu() {
            const dropdown = document.getElementById('userDropdown');
            dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
        }

        function toggleMobileMenu() {
            const nav = document.querySelector('.nav');
            nav.classList.toggle('active');
        }

        function logout() {
            localStorage.clear();
            showNotification('✅ Logged out', 'success');
            checkAuthStatus();
        }

        // Load user data on page load
        window.addEventListener('DOMContentLoaded', async function() {
            checkAuthStatus();
            // Check if user is logged in
            const token = localStorage.getItem('token');
            if (!token) {
                showNotification('⚠️ Please login first!', 'error');
                setTimeout(() => {
                    window.location.href = 'home_page.html';
                }, 2000);
                return;
            }

            // Fetch user profile from API
            try {
                console.log('🔄 Fetching profile from /api/Users/Get-My-Profile...');
                
                // Use /Users/Get-My-Profile endpoint
                const response = await window.API.getMyProfile();
                console.log('📦 Profile response:', response);
                
                // Response structure: { isSuccess, message, data: { id, email, firstName, lastName, phoneNumber, ... } }
                const profile = response.data || response;
                
                console.log('✅ Profile data:', profile);
                
                // Check if profile data exists
                if (!profile || typeof profile !== 'object') {
                    throw new Error('Invalid profile data received');
                }
                
                // Save user ID
                if (profile.id) {
                    localStorage.setItem('userId', profile.id);
                    console.log('✅ Saved userId:', profile.id);
                }
                
                // Display email
                if (profile.email) {
                    localStorage.setItem('userEmail', profile.email);
                    document.getElementById('email').value = profile.email;
                    document.getElementById('email').readOnly = true; // Email should not be editable
                    console.log('✅ Saved email:', profile.email);
                }
                
                // Display full name (firstName + lastName)
                const fullName = [profile.firstName, profile.lastName].filter(Boolean).join(' ') || profile.email || 'User';
                document.getElementById('username').value = fullName;
                localStorage.setItem('username', fullName);
                console.log('✅ Updated username:', fullName);
                
                // Display phone number
                if (profile.phoneNumber) {
                    document.getElementById('phone').value = profile.phoneNumber;
                    localStorage.setItem('userPhone', profile.phoneNumber);
                    console.log('✅ Updated phone:', profile.phoneNumber);
                } else {
                    // If no phone from API, try cached value
                    const cachedPhone = localStorage.getItem('userPhone');
                    if (cachedPhone) {
                        document.getElementById('phone').value = cachedPhone;
                    }
                }
                
                showNotification('✅ Profile loaded successfully!', 'success');
                
            } catch (error) {
                console.error('❌ Failed to fetch user profile:', error);
                console.error('Error details:', {
                    message: error.message,
                    response: error.response,
                    status: error.response?.status,
                    statusText: error.response?.statusText,
                    data: error.response?.data
                });
                
                // Fallback to localStorage if API fails
                console.log('⚠️ Falling back to localStorage...');
                const userEmail = localStorage.getItem('userEmail');
                const username = localStorage.getItem('username');
                const userPhone = localStorage.getItem('userPhone');
                
                if (userEmail) {
                    document.getElementById('email').value = userEmail;
                }
                if (username) {
                    document.getElementById('username').value = username;
                }
                if (userPhone) {
                    document.getElementById('phone').value = userPhone;
                }
                
                showNotification('⚠️ Could not fetch latest profile. Showing cached data.', 'error');
            }
        });

        // Handle file uploads
        document.getElementById('driver-license').addEventListener('change', function(e) {
            const fileName = e.target.files[0]?.name || 'No file selected';
            this.previousElementSibling.textContent = fileName;
        });

        document.getElementById('id-card').addEventListener('change', function(e) {
            const fileName = e.target.files[0]?.name || 'No file selected';
            this.previousElementSibling.textContent = fileName;
        });

        // Change Password Modal Functions
        function openChangePasswordModal() {
            document.getElementById('changePasswordModal').style.display = 'block';
        }

        function closeChangePasswordModal() {
            document.getElementById('changePasswordModal').style.display = 'none';
            document.getElementById('changePasswordForm').reset();
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('changePasswordModal');
            if (event.target == modal) {
                closeChangePasswordModal();
            }
        }

        // Show notification
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type} show`;
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // Toggle password visibility
        function togglePasswordVisibility(inputId) {
            const input = document.getElementById(inputId);
            const icon = input.nextElementSibling;
            
            console.log('=== Toggle Password Debug ===');
            console.log('Input ID:', inputId);
            console.log('Input element:', input);
            console.log('Current type:', input.type);
            console.log('Current value:', input.value);
            console.log('Icon element:', icon);
            
            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
                console.log('✓ Changed to TEXT type');
            } else {
                input.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
                console.log('✓ Changed to PASSWORD type');
            }
            
            console.log('New type:', input.type);
            console.log('========================');
        }

        // Handle change password form submission
        document.getElementById('changePasswordForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            // Validate password match
            if (newPassword !== confirmPassword) {
                showNotification('⚠️ New passwords do not match!', 'error');
                return;
            }

            // Validate password strength
            const passwordRegex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&#])[A-Za-z\d@$!%*?&#]{8,}$/;
            if (!passwordRegex.test(newPassword)) {
                showNotification('⚠️ Password must contain uppercase, lowercase, digit, and special character', 'error');
                return;
            }

            try {
                // Check if API is loaded
                if (!window.API || !window.API.changePassword) {
                    showNotification('❌ API not loaded. Please refresh the page.', 'error');
                    console.error('window.API:', window.API);
                    return;
                }

                // Get userId from localStorage first
                let userId = localStorage.getItem('userId');
                
                // If no userId in localStorage, fetch from API
                if (!userId) {
                    console.log('UserId not in localStorage. Fetching from API...');
                    try {
                        const userData = await window.API.getMe();
                        userId = userData.userId;
                        
                        if (userId) {
                            localStorage.setItem('userId', userId);
                            console.log('✅ Fetched and saved userId:', userId);
                        }
                    } catch (error) {
                        console.error('Failed to fetch userId:', error);
                    }
                }
                
                // Final check
                if (!userId) {
                    showNotification('❌ User ID not found. Please logout and login again.', 'error');
                    console.error('userId not found. User needs to login again.');
                    return;
                }
                
                console.log('Calling API.changePassword with userId:', userId);
                const response = await window.API.changePassword(userId, currentPassword, newPassword);

                if (response) {
                    showNotification('✅ Password changed successfully!', 'success');
                    closeChangePasswordModal();
                }
            } catch (error) {
                console.error('Change password error:', error);
                const errorMessage = error.message || 
                                   'Failed to change password. Please check your current password.';
                showNotification(`❌ ${errorMessage}`, 'error');
            }
        });

        // ========== LOGIN/REGISTER MODAL FUNCTIONS ==========
        function openModal() {
            document.getElementById("modal").style.display = "flex";
        }

        function closeModal() {
            document.getElementById("modal").style.display = "none";
        }

        function openRegisterModal() {
            closeModal();
            document.getElementById("registerModal").style.display = "flex";
        }

        function closeRegisterModal() {
            document.getElementById("registerModal").style.display = "none";
        }

        // ========== LOGIN FORM HANDLER ==========
        const loginForm = document.getElementById('loginForm');
        if (loginForm) {
            loginForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                const email = document.getElementById('loginEmail').value.trim();
                const password = document.getElementById('loginPassword').value;
                
                if (!email || !password) {
                    showNotification('❌ Please enter email and password!', 'error');
                    return;
                }
                
                try {
                    const response = await window.API.login(email, password);
                    if (response.token) {
                        localStorage.setItem('token', response.token);
                        if (response.user && response.user.id) localStorage.setItem('userId', response.user.id);
                        if (response.user && response.user.email) localStorage.setItem('userEmail', response.user.email);
                        showNotification('🎉 Login successful!', 'success');
                        closeModal();
                        checkAuthStatus();
                        loginForm.reset();
                        location.reload();
                    } else {
                        showNotification('⚠️ Invalid server response.', 'error');
                    }
                } catch (error) {
                    showNotification(`❌ ${error.message || 'Login failed'}`, 'error');
                }
            });
        }

        // ========== REGISTER FORM HANDLER ==========
        const registerForm = document.getElementById('registerForm');
        if (registerForm) {
            registerForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                const username = document.getElementById('registerUsername').value.trim();
                const email = document.getElementById('registerEmail').value.trim();
                const phoneNumber = document.getElementById('registerPhone').value.trim();
                const password = document.getElementById('registerPassword').value;
                
                try {
                    await window.API.register(username, email, phoneNumber, password);
                    showNotification('🎊 Registration successful!', 'success');
                    closeRegisterModal();
                    setTimeout(() => {
                        openModal();
                        showNotification('💡 You can login now!', 'success');
                    }, 2000);
                } catch (error) {
                    showNotification(`❌ ${error.message || 'Registration failed'}`, 'error');
                }
            });
        }
    </script>
</body>

</html>