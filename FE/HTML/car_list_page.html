<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Available Cars - FEC</title>
    <link rel="stylesheet" href="../style.css" />
    <link rel="stylesheet" href="../CSS/shared.css" />
    <link rel="stylesheet" href="../CSS/car_list_page.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="../api.js"></script>
</head>

<body>
    <header class="header">
        <div class="container header-container">
            <div class="logo">
                <a href="home_page.html">FEC</a>
            </div>

            <button class="mobile-menu-btn" onclick="toggleMobileMenu()">
                <i class="fas fa-bars"></i>
            </button>

            <nav class="nav">
                <div class="navbar-right">
                    <!-- Login button for non-authenticated users -->
                    <button id="loginBtn" onclick="openModal()" class="login-nav-btn">Login</button>
                    
                    <!-- User menu for authenticated users -->
                    <div id="userMenu" class="user-menu" style="display: none;">
                        <button class="user-menu-btn" onclick="toggleUserMenu()">
                            <i class="fas fa-user-circle"></i>
                            <i class="fas fa-chevron-down"></i>
                        </button>
                        <div id="userDropdown" class="user-dropdown">
                            <div class="dropdown-header">
                                <i class="fas fa-user-circle"></i>
                                <span id="userEmail">User Account</span>
                            </div>
                            <hr>
                            <a href="#" onclick="openUserProfile()">
                                <i class="fas fa-user-cog"></i> User Profile
                            </a>
                            <a href="booking_history.html" onclick="toggleUserMenu()">
                                <i class="fas fa-history"></i> Booking History
                            </a>
                            <a href="#" onclick="logout()">
                                <i class="fas fa-sign-out-alt"></i> Logout
                            </a>
                        </div>
                    </div>
                </div>
            </nav>
        </div>
    </header>

    <main class="car-list-main">
        <section class="search-form">
            <div class="container">
                <form id="car-search-form">
                    <div class="search-grid">
                        <div class="form-group">
                            <label for="location">
                                <i class="fas fa-map-marker-alt"></i>
                                Pick-up Location
                            </label>
                            <select id="location" name="location" required>
                                <option value="">Select location</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="pickup-date">
                                <i class="fas fa-calendar"></i>
                                Pick-up Date
                            </label>
                            <input type="date" id="pickup-date" name="pickup-date" required />
                        </div>

                        <div class="form-group">
                            <label for="pickup-time">
                                <i class="fas fa-clock"></i>
                                Pick-up Time
                            </label>
                            <select id="pickup-time" name="pickup-time" required>
                                <option value="">Select hour</option>
                                <option value="06:00">06:00</option>
                                <option value="07:00">07:00</option>
                                <option value="08:00">08:00</option>
                                <option value="09:00">09:00</option>
                                <option value="10:00">10:00</option>
                                <option value="11:00">11:00</option>
                                <option value="12:00">12:00</option>
                                <option value="13:00">13:00</option>
                                <option value="14:00">14:00</option>
                                <option value="15:00">15:00</option>
                                <option value="16:00">16:00</option>
                                <option value="17:00">17:00</option>
                                <option value="18:00">18:00</option>
                                <option value="19:00">19:00</option>
                                <option value="20:00">20:00</option>
                                <option value="21:00">21:00</option>
                                <option value="22:00">22:00</option>
                                <option value="23:00">23:00</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="return-date">
                                <i class="fas fa-calendar-check"></i>
                                Return Date
                            </label>
                            <input type="date" id="return-date" name="return-date" required />
                        </div>

                        <div class="form-group">
                            <label for="return-time">
                                <i class="fas fa-clock"></i>
                                Return Time
                            </label>
                            <select id="return-time" name="return-time" required>
                                <option value="">Select hour</option>
                                <option value="06:00">06:00</option>
                                <option value="07:00">07:00</option>
                                <option value="08:00">08:00</option>
                                <option value="09:00">09:00</option>
                                <option value="10:00">10:00</option>
                                <option value="11:00">11:00</option>
                                <option value="12:00">12:00</option>
                                <option value="13:00">13:00</option>
                                <option value="14:00">14:00</option>
                                <option value="15:00">15:00</option>
                                <option value="16:00">16:00</option>
                                <option value="17:00">17:00</option>
                                <option value="18:00">18:00</option>
                                <option value="19:00">19:00</option>
                                <option value="20:00">20:00</option>
                                <option value="21:00">21:00</option>
                                <option value="22:00">22:00</option>
                                <option value="23:00">23:00</option>
                            </select>
                        </div>

                        <button type="submit" class="btn-search">
                            <i class="fas fa-search"></i>
                            SEARCH
                        </button>
                    </div>
                </form>
            </div>
        </section>

        <div class="container">
            <div class="filter-section">
                <div style="display:flex; align-items:center; justify-content:space-between; gap:1rem;">
                    <h3>Filters</h3>
                    <div style="display:flex; gap:.5rem; align-items:center;">
                        <small id="filter-count" style="color:#666">Showing 0 cars</small>
                        <button id="resetFiltersBtn" type="button" class="btn-apply-filters" style="background:#eee;color:#333;padding:.4rem .8rem;border-radius:6px;">Reset</button>
                        <button id="applyFiltersBtn" type="button" class="btn-apply-filters">Apply Filters</button>
                    </div>
                </div>
                <form id="filter-form" onsubmit="return false;" style="margin-top:12px; display:flex; gap:12px; align-items:flex-end;">
                    <div class="filter-group" style="flex:1;">
                        <label>Brand</label>
                        <select id="filter-brand" name="brand"><option value="">Any Brand</option></select>
                    </div>
                    <div class="filter-group" style="flex:1;">
                        <label>Color</label>
                        <select id="filter-color" name="color"><option value="">Any Color</option></select>
                    </div>
                    <div class="filter-group" style="width:120px;">
                        <label>Seats</label>
                        <select id="filter-seats" name="seats"><option value="">Any</option><option value="2">2</option><option value="4">4</option><option value="5">5</option><option value="7">7</option></select>
                    </div>
                    <div class="filter-group" style="width:120px;">
                        <label>Year (min)</label>
                        <input id="filter-year" type="number" min="1900" max="2100" placeholder="2020" />
                    </div>
                    <div class="filter-group" style="width:140px;">
                        <label>Price min</label>
                        <input id="filter-price-min" type="number" min="0" placeholder="0" />
                    </div>
                    <div class="filter-group" style="width:140px;">
                        <label>Price max</label>
                        <input id="filter-price-max" type="number" min="0" placeholder="999" />
                    </div>
                </form>
            </div>

            <div class="car-list">
                <!-- Car Cards -->
                <div class="car-card" onclick="window.location.href='car_detail.html?id=1'">
                    <div class="car-image">
                        <i class="fas fa-car car-placeholder-icon"></i>
                        <span class="car-tag">Electric</span>
                    </div>
                    <div class="car-info">
                        <div class="car-header">
                            <h3 class="car-name">Tesla Model 3</h3>
                            <div class="car-price">$15/hour</div>
                        </div>
                        <div class="car-features">
                            <span><i class="fas fa-battery-three-quarters"></i> 350km Range</span>
                            <span><i class="fas fa-bolt"></i> Fast Charging</span>
                            <span><i class="fas fa-user"></i> 5 seats</span>
                        </div>
                        <div class="car-rating">
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star-half"></i>
                            <span>(32 reviews)</span>
                        </div>
                    </div>
                </div>

                <div class="car-card" onclick="window.location.href='car_detail.html?id=2'">
                    <div class="car-image">
                        <i class="fas fa-car car-placeholder-icon"></i>
                        <span class="car-tag">Electric</span>
                    </div>
                    <div class="car-info">
                        <div class="car-header">
                            <h3 class="car-name">Nissan Leaf</h3>
                            <div class="car-price">$12/hour</div>
                        </div>
                        <div class="car-features">
                            <span><i class="fas fa-battery-three-quarters"></i> 300km Range</span>
                            <span><i class="fas fa-bolt"></i> Fast Charging</span>
                            <span><i class="fas fa-user"></i> 5 seats</span>
                        </div>
                        <div class="car-rating">
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star"></i>
                            <i class="far fa-star"></i>
                            <span>(28 reviews)</span>
                        </div>
                    </div>
                </div>

                <!-- Additional car cards for demonstration -->
                <div class="car-card" onclick="window.location.href='car_detail.html?id=3'">
                    <div class="car-image">
                        <i class="fas fa-car car-placeholder-icon"></i>
                        <span class="car-tag">Electric</span>
                    </div>
                    <div class="car-info">
                        <div class="car-header">
                            <h3 class="car-name">BMW i4</h3>
                            <div class="car-price">$18/hour</div>
                        </div>
                        <div class="car-features">
                            <span><i class="fas fa-battery-three-quarters"></i> 400km Range</span>
                            <span><i class="fas fa-bolt"></i> Fast Charging</span>
                            <span><i class="fas fa-user"></i> 5 seats</span>
                        </div>
                        <div class="car-rating">
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star"></i>
                            <span>(45 reviews)</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer class="footer">
        <div class="container">
            <p>&copy; 2025 FEC. All rights reserved.</p>
        </div>
    </footer>

    <!-- Modals -->
    <div id="modal" class="modal-overlay">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal()">&times;</span>
            <h2>LOGIN</h2>
            <form>
                <input type="text" placeholder="Enter Username" required>
                <input type="password" placeholder="Enter Password" required>
                <a href="#">Forgot Password?</a>
                <button type="submit">Login</button>
                <a href="#" onclick="openRegisterModal()">Create Account</a>
            </form>
        </div>
    </div>

    <div id="registerModal" class="modal-overlay">
        <div class="modal-content">
            <span class="close-btn" onclick="closeRegisterModal()">&times;</span>
            <h2>Register</h2>
            <form>
                <input type="text" placeholder="Enter Username" required>
                <input type="email" placeholder="Enter Email" required>
                <input type="password" placeholder="Enter Password" required>
                <input type="password" placeholder="Confirm Password" required>
                <button type="submit">Create Account</button>
            </form>
        </div>
    </div>

    <script>
        // ============= GLOBAL STATE =============
        let currentStationId = null;
        let currentSearchParams = {};

        // ============= NOTIFICATION =============
        function showNotification(message, type = 'success') {
            const existingNotifications = document.querySelectorAll('.notification');
            existingNotifications.forEach(notification => notification.remove());

            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <span>${message}</span>
                <span class="close-btn" onclick="this.parentElement.remove()">&times;</span>
            `;

            document.body.appendChild(notification);
            setTimeout(() => notification.classList.add('show'), 100);
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.classList.remove('show');
                    setTimeout(() => notification.remove(), 300);
                }
            }, 5000);
        }

        // ============= AUTH FUNCTIONS =============
        function checkAuthStatus() {
            const token = localStorage.getItem('token');
            const loginBtn = document.getElementById('loginBtn');
            const userMenu = document.getElementById('userMenu');
            const userEmail = document.getElementById('userEmail');
            
            if (token && token !== 'null' && token !== '') {
                if (loginBtn) loginBtn.style.display = 'none';
                if (userMenu) userMenu.style.display = 'block';
                
                const savedEmail = localStorage.getItem('userEmail');
                if (savedEmail && userEmail) {
                    userEmail.textContent = savedEmail;
                } else if (userEmail) {
                    userEmail.textContent = 'User Account';
                }
            } else {
                localStorage.removeItem('token');
                localStorage.removeItem('userEmail');
                
                if (loginBtn) loginBtn.style.display = 'inline-block';
                if (userMenu) userMenu.style.display = 'none';
            }
        }

        function toggleUserMenu() {
            const dropdown = document.getElementById('userDropdown');
            dropdown.classList.toggle('show');
        }

        function openUserProfile() {
            document.getElementById('userDropdown').classList.remove('show');
            const token = localStorage.getItem('token');
            if (!token || token === 'null' || token === '') {
                showNotification('⚠️ Vui lòng đăng nhập để xem profile!', 'error');
                return;
            }
            window.location.href = 'user_profile.html';
        }

        function logout() {
            document.getElementById('userDropdown').classList.remove('show');
            localStorage.removeItem('token');
            localStorage.removeItem('userEmail');
            checkAuthStatus();
            showNotification('👋 Bạn đã đăng xuất thành công!', 'success');
        }

        function openModal() {
            document.getElementById("modal").style.display = "flex";
        }

        function closeModal() {
            document.getElementById("modal").style.display = "none";
        }

        function openRegisterModal() {
            closeModal();
            document.getElementById("registerModal").style.display = "flex";
        }

        function closeRegisterModal() {
            document.getElementById("registerModal").style.display = "none";
        }

        function toggleMobileMenu() {
            const sidebar = document.querySelector('.sidebar');
            const overlay = document.querySelector('.overlay');
            
            if (sidebar && sidebar.classList.contains('active')) {
                sidebar.classList.remove('active');
                if (overlay) overlay.classList.remove('active');
                document.body.style.overflow = 'auto';
            } else if (sidebar) {
                sidebar.classList.add('active');
                if (overlay) overlay.classList.add('active');
                document.body.style.overflow = 'hidden';
            }
        }

        // ============= STATION DROPDOWN =============
        async function populateStationDropdown() {
            const dropdown = document.getElementById('location');
            if (!dropdown) {
                console.error('Station dropdown not found');
                return;
            }

            console.log('📍 Populating station dropdown...');

            try {
                if (!window.API || typeof window.API.getAllStations !== 'function') {
                    console.error('window.API.getAllStations is not available');
                    showNotification('❌ API not loaded', 'error');
                    return;
                }

                const stations = await window.API.getAllStations();
                console.log('✅ Stations loaded:', stations.length);

                dropdown.innerHTML = '<option value="">Select location</option>';

                stations.forEach(station => {
                    const id = station.id || station.Id || station.stationId;
                    const name = station.name || station.Name || station.stationName;

                    if (!id || !name) return;

                    const option = document.createElement('option');
                    option.value = id;
                    option.textContent = name;
                    dropdown.appendChild(option);
                });

                // Set dropdown to URL param if present
                const params = new URLSearchParams(window.location.search);
                const urlStationId = params.get('location');
                if (urlStationId) {
                    dropdown.value = urlStationId;
                    console.log('🎯 Set dropdown to URL station:', urlStationId);
                }

                if (stations.length === 0) {
                    showNotification('⚠️ No stations available', 'error');
                }
            } catch (error) {
                console.error('❌ Error loading stations:', error);
                showNotification('❌ Failed to load stations', 'error');
            }
        }

        // ============= LOAD CARS BY STATION =============
        async function loadCarsByStation(stationId) {
            if (!stationId) {
                console.warn('⚠️ No stationId provided');
                displayNoCars('Please select a location to view available cars');
                return;
            }

            console.log('🚗 Loading cars for station:', stationId);
            currentStationId = stationId;

            const carListContainer = document.querySelector('.car-list');
            if (!carListContainer) {
                console.error('Car list container not found');
                return;
            }

            // Show loading
            carListContainer.innerHTML = '<div class="loading">Loading available cars...</div>';

            try {
                if (!window.API || typeof window.API.getAvailableCarsByStation !== 'function') {
                    console.error('window.API.getAvailableCarsByStation is not available');
                    displayNoCars('API not available');
                    return;
                }

                const cars = await window.API.getAvailableCarsByStation(stationId);
                console.log('✅ Cars loaded:', cars.length);

                if (!cars || cars.length === 0) {
                    displayNoCars('No cars available at this location');
                    return;
                }

                // persist loaded cars so filters can operate client-side without reloading
                try { window._loadedCars = Array.isArray(cars) ? cars.slice() : []; } catch(e) { window._loadedCars = []; }

                // build filter dropdowns
                buildFilterOptions(window._loadedCars || []);

                displayCars(cars);
                const fc = document.getElementById('filter-count'); if (fc) fc.textContent = `Showing ${ (window._loadedCars||[]).length } car${ (window._loadedCars||[]).length===1?'':'s'}`;
            } catch (error) {
                console.error('❌ Error loading cars:', error);
                displayNoCars('Failed to load cars. Please try again.');
                showNotification('❌ Failed to load cars', 'error');
            }
        }

        // ============= DISPLAY FUNCTIONS =============
        function displayCars(cars) {
            const carListContainer = document.querySelector('.car-list');
            if (!carListContainer) return;

            carListContainer.innerHTML = '';

            cars.forEach(car => {
                const carCard = createCarCard(car);
                carListContainer.appendChild(carCard);
            });
        }

        // ============= FILTERS (client-side) =============
        function applyFilters() {
            const cars = window._loadedCars || [];
            if (!cars.length) return;
            const brand = (document.getElementById('filter-brand')||{}).value || '';
            const color = (document.getElementById('filter-color')||{}).value || '';
            const seats = parseInt((document.getElementById('filter-seats')||{}).value || '0',10) || 0;
            const yearMin = parseInt((document.getElementById('filter-year')||{}).value || '0',10) || 0;
            const priceMin = parseFloat((document.getElementById('filter-price-min')||{}).value || '0') || 0;
            const priceMax = parseFloat((document.getElementById('filter-price-max')||{}).value || '0') || 0;

            const filtered = cars.filter(c => {
                const carBrand = (c.brand || c.Brand || c.make || '').toString().trim();
                const carColor = (c.color || c.Color || '').toString().trim();
                const carSeats = parseInt(c.seats || c.Seats || 0,10) || 0;
                const carYear = parseInt(c.year || c.Year || 0,10) || 0;
                const carPrice = parseFloat(c.rentalPricePerHour || c.pricePerHour || c.PricePerHour || 0) || 0;

                if (brand && brand.toLowerCase() !== carBrand.toLowerCase()) return false;
                if (color && color.toLowerCase() !== carColor.toLowerCase()) return false;
                if (seats && carSeats !== seats) return false;
                if (yearMin && carYear < yearMin) return false;
                if (priceMin && carPrice < priceMin) return false;
                if (priceMax && priceMax > 0 && carPrice > priceMax) return false;

                return true;
            });

            displayCars(filtered);
            const fc = document.getElementById('filter-count'); if (fc) fc.textContent = `Showing ${filtered.length} car${filtered.length===1?'':'s'}`;
        }

        function resetFilters() {
            const form = document.getElementById('filter-form');
            if (form) form.reset();
            displayCars(window._loadedCars || []);
            const fc = document.getElementById('filter-count'); if (fc) fc.textContent = `Showing ${ (window._loadedCars||[]).length } car${ (window._loadedCars||[]).length===1?'':'s'}`;
        }

        // Build brand/color options based on loaded cars
        function buildFilterOptions(cars) {
            const brandSet = new Set();
            const colorSet = new Set();

            cars.forEach(c => {
                const b = (c.brand || c.Brand || '').toString().trim();
                const col = (c.color || c.Color || '').toString().trim();
                if (b) brandSet.add(b);
                if (col) colorSet.add(col);
            });

            const brandSel = document.getElementById('filter-brand');
            const colorSel = document.getElementById('filter-color');

            if (brandSel) {
                brandSel.innerHTML = '<option value="">Any Brand</option>' + Array.from(brandSet).sort().map(b => `<option value="${b}">${b}</option>`).join('');
            }
            if (colorSel) {
                colorSel.innerHTML = '<option value="">Any Color</option>' + Array.from(colorSet).sort().map(c => `<option value="${c}">${c}</option>`).join('');
            }
        }

        function createCarCard(car) {
            const div = document.createElement('div');
            div.className = 'car-card';
            div.onclick = () => {
                // Save rental context before navigating
                saveRentalContext();
                window.location.href = `car_detail.html?id=${car.id || car.carId}`;
            };

            const id = car.id || car.carId || car.Id;
            // Prefer Brand + Model when available (support multiple casing)
            const brand = car.brand || car.Brand || car.make || car.Make || '';
            const model = car.model || car.Model || car.modelName || car.ModelName || '';
            const nameFallback = car.name || car.carName || car.Name || 'Unknown Car';
            const displayName = (brand && model) ? `${brand} ${model}` : (brand ? `${brand} ${model}`.trim() : nameFallback);
            const pricePerHour = car.rentalPricePerHour || car.pricePerHour || car.PricePerHour || 0;
            const color = car.color || car.Color || 'Unknown';
            const year = car.year || car.Year || '';
            const seats = car.seats || car.Seats || 5;
            const imageUrl = car.imageUrl || car.ImageUrl || '';
            const rating = car.rating || car.Rating || 4.5;
            const reviewCount = car.reviewCount || car.ReviewCount || 0;

            // Use car icon if no image URL
            const imageHtml = imageUrl ? 
                `<img src="${imageUrl}" alt="${name}" onerror="this.parentElement.innerHTML='<i class=\\'fas fa-car car-placeholder-icon\\'></i>'" />` :
                `<i class="fas fa-car car-placeholder-icon"></i>`;

            div.innerHTML = `
                <div class="car-image">
                    ${imageHtml}
                    <span class="car-tag">Electric</span>
                </div>
                <div class="car-info">
                    <div class="car-header">
                        <h3 class="car-name">${displayName}</h3>
                        <div class="car-price">$${pricePerHour}/hour</div>
                    </div>
                    <div class="car-features">
                        <span><i class="fas fa-fill-drip"></i> ${color}</span>
                        <span><i class="fas fa-calendar-alt"></i> ${year}</span>
                        <span><i class="fas fa-user"></i> ${seats} seats</span>
                    </div>
                    <div class="car-rating">
                        ${generateStars(rating)}
                        <span>(${reviewCount} reviews)</span>
                    </div>
                </div>
            `;

            return div;
        }

        function generateStars(rating) {
            let stars = '';
            const fullStars = Math.floor(rating);
            const hasHalfStar = rating % 1 >= 0.5;

            for (let i = 0; i < fullStars; i++) {
                stars += '<i class="fas fa-star"></i>';
            }
            if (hasHalfStar) {
                stars += '<i class="fas fa-star-half"></i>';
            }
            const emptyStars = 5 - Math.ceil(rating);
            for (let i = 0; i < emptyStars; i++) {
                stars += '<i class="far fa-star"></i>';
            }
            return stars;
        }

        function displayNoCars(message) {
            const carListContainer = document.querySelector('.car-list');
            if (!carListContainer) return;

            carListContainer.innerHTML = `
                <div class="no-cars-message">
                    <i class="fas fa-car" style="font-size: 48px; color: #ccc; margin-bottom: 16px;"></i>
                    <p>${message}</p>
                </div>
            `;
        }

        // ============= RENTAL CONTEXT =============
        function saveRentalContext() {
            const rentalContext = {
                stationId: document.getElementById('location').value,
                stationName: document.getElementById('location').options[document.getElementById('location').selectedIndex]?.text || '',
                pickupDate: document.getElementById('pickup-date').value,
                pickupTime: document.getElementById('pickup-time').value,
                returnDate: document.getElementById('return-date').value,
                returnTime: document.getElementById('return-time').value,
                createdAt: new Date().toISOString()
            };
            try {
                localStorage.setItem('rentalContext', JSON.stringify(rentalContext));
                console.log('💾 Rental context saved:', rentalContext);
            } catch (e) {
                console.error('Failed to save rental context:', e);
            }
        }

        // ============= SEARCH FORM =============
        function handleSearchFormSubmit(e) {
            e.preventDefault();

            const stationId = document.getElementById('location').value;
            const pickupDate = document.getElementById('pickup-date').value;
            const pickupTime = document.getElementById('pickup-time').value;
            const returnDate = document.getElementById('return-date').value;
            const returnTime = document.getElementById('return-time').value;

            console.log('🔍 Search form submitted:', { stationId, pickupDate, pickupTime, returnDate, returnTime });

            if (!stationId) {
                showNotification('⚠️ Please select a location', 'error');
                return;
            }

            // Validate dates
            if (pickupDate && returnDate && pickupTime && returnTime) {
                const pickup = new Date(`${pickupDate}T${pickupTime}`);
                const returnDt = new Date(`${returnDate}T${returnTime}`);
                
                if (returnDt <= pickup) {
                    showNotification('⚠️ Return time must be after pickup time', 'error');
                    return;
                }
            }

            // Save rental context
            saveRentalContext();

            // Update URL params
            const params = new URLSearchParams();
            params.set('location', stationId);
            if (pickupDate) params.set('pickup-date', pickupDate);
            if (pickupTime) params.set('pickup-time', pickupTime);
            if (returnDate) params.set('return-date', returnDate);
            if (returnTime) params.set('return-time', returnTime);

            // Update URL without reload
            const newUrl = `${window.location.pathname}?${params.toString()}`;
            window.history.pushState({}, '', newUrl);

            // Reload cars
            loadCarsByStation(stationId);
        }

        // ============= INITIALIZATION =============
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('🚀 Car list page initializing...');

            // Check auth
            checkAuthStatus();

            // Populate station dropdown
            await populateStationDropdown();

            // Get URL parameters
            const params = new URLSearchParams(window.location.search);
            const stationId = params.get('location');
            const pickupDate = params.get('pickup-date');
            const pickupTime = params.get('pickup-time');
            const returnDate = params.get('return-date');
            const returnTime = params.get('return-time');

            console.log('🔗 URL Parameters:', { stationId, pickupDate, pickupTime, returnDate, returnTime });

            // Fill form with URL params
            if (pickupDate) document.getElementById('pickup-date').value = pickupDate;
            if (pickupTime) document.getElementById('pickup-time').value = pickupTime;
            if (returnDate) document.getElementById('return-date').value = returnDate;
            if (returnTime) document.getElementById('return-time').value = returnTime;

            // Load cars if stationId provided
            if (stationId) {
                await loadCarsByStation(stationId);
            } else {
                displayNoCars('Please select a location to view available cars');
            }

            // Attach search form handler
            const searchForm = document.getElementById('car-search-form');
            if (searchForm) {
                searchForm.addEventListener('submit', handleSearchFormSubmit);
                console.log('✅ Search form handler attached');
            }

            // Wire up filter buttons (client-side)
            const applyBtn = document.getElementById('applyFiltersBtn');
            const resetBtn = document.getElementById('resetFiltersBtn');
            if (applyBtn) applyBtn.addEventListener('click', applyFilters);
            if (resetBtn) resetBtn.addEventListener('click', resetFilters);

            // Auto-apply filters when user changes any filter control (debounced)
            const debounce = (fn, wait) => {
                let t;
                return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), wait); };
            };

            const autoApply = debounce(() => { applyFilters(); }, 250);

            // List of filter control ids
            const filterIds = ['filter-brand','filter-color','filter-seats','filter-year','filter-price-min','filter-price-max'];
            filterIds.forEach(id => {
                const el = document.getElementById(id);
                if (!el) return;
                // use input event for text/number, change for select
                const ev = (el.tagName === 'SELECT' ? 'change' : 'input');
                el.addEventListener(ev, autoApply);
            });

            // Hide the Apply button because filters auto-apply
            if (applyBtn) applyBtn.style.display = 'none';

            // Close dropdown when clicking outside
            document.addEventListener('click', function(event) {
                const userMenu = document.querySelector('.user-menu');
                const dropdown = document.getElementById('userDropdown');
                
                if (userMenu && !userMenu.contains(event.target)) {
                    dropdown.classList.remove('show');
                }
            });

            // ========== LOGIN FORM HANDLER ==========
            const loginForm = document.getElementById('loginForm');
            if (loginForm) {
                loginForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    const email = document.getElementById('loginEmail').value.trim();
                    const password = document.getElementById('loginPassword').value;
                    
                    if (!email || !password) {
                        showNotification('❌ Please enter email and password!', 'error');
                        return;
                    }
                    
                    console.log('Attempting login with email:', email);
                    
                    try {
                        const response = await window.API.login(email, password);
                        
                        if (response.token) {
                            localStorage.setItem('token', response.token);
                            if (response.user && response.user.id) {
                                localStorage.setItem('userId', response.user.id);
                            }
                            if (response.user && response.user.email) {
                                localStorage.setItem('userEmail', response.user.email);
                            }
                            
                            showNotification('🎉 Login successful!', 'success');
                            closeModal();
                            checkAuthStatus();
                            loginForm.reset();
                        } else {
                            showNotification('⚠️ Invalid server response.', 'error');
                        }
                    } catch (error) {
                        console.error('Login error:', error);
                        const errorMsg = error.message || 'Login failed';
                        showNotification(`❌ ${errorMsg}`, 'error');
                    }
                });
            }

            // ========== REGISTER FORM HANDLER ==========
            const registerForm = document.getElementById('registerForm');
            if (registerForm) {
                registerForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    const username = document.getElementById('registerUsername').value.trim();
                    const email = document.getElementById('registerEmail').value.trim();
                    const phoneNumber = document.getElementById('registerPhone').value.trim();
                    const password = document.getElementById('registerPassword').value;
                    
                    try {
                        const response = await window.API.register(username, email, phoneNumber, password);
                        showNotification('🎊 Registration successful!', 'success');
                        closeRegisterModal();
                        setTimeout(() => {
                            openModal();
                            showNotification('💡 You can login now!', 'success');
                        }, 2000);
                    } catch (error) {
                        console.error('Register error:', error);
                        const errorMsg = error.message || 'Registration failed';
                        showNotification(`❌ ${errorMsg}`, 'error');
                    }
                });
            }

            console.log('✅ Car list page initialized');
        });
    </script>
</body>

</html>
