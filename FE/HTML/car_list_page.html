<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Available Cars - FEC</title>
    <link rel="stylesheet" href="../style.css" />
    <link rel="stylesheet" href="../CSS/shared.css" />
    <link rel="stylesheet" href="../CSS/car_list_page.css" />
    <link rel="stylesheet" href="../CSS/search_modal.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="../api.js"></script>
</head>

<body>
    <header class="header">
        <div class="container header-container">
            <div class="logo">
                <a href="home_page.html">FEC</a>
            </div>

            <button class="mobile-menu-btn" onclick="toggleMobileMenu()">
                <i class="fas fa-bars"></i>
            </button>

            <nav class="nav">
                <div class="navbar-right">
                    <!-- Login button for non-authenticated users -->
                    <button id="loginBtn" onclick="openModal()" class="login-nav-btn">Login</button>
                    
                    <!-- User menu for authenticated users -->
                    <div id="userMenu" class="user-menu" style="display: none;">
                        <button class="user-menu-btn" onclick="toggleUserMenu()">
                            <i class="fas fa-user-circle"></i>
                            <i class="fas fa-chevron-down"></i>
                        </button>
                        <div id="userDropdown" class="user-dropdown">
                            <div class="dropdown-header">
                                <i class="fas fa-user-circle"></i>
                                <span id="userEmail">User Account</span>
                            </div>
                            <hr>
                            <a href="#" onclick="openUserProfile()">
                                <i class="fas fa-user-cog"></i> User Profile
                            </a>
                            <a href="booking_history.html" onclick="toggleUserMenu()">
                                <i class="fas fa-history"></i> Booking History
                            </a>
                            <a href="#" onclick="logout()">
                                <i class="fas fa-sign-out-alt"></i> Logout
                            </a>
                        </div>
                    </div>
                </div>
            </nav>
        </div>
    </header>

    <main class="car-list-main">
        <!-- Search Bar Section -->
        <section class="search-form">
            <div class="container">
                <div class="search-summary">
                    <div class="summary-item" onclick="openSearchModal()">
                        <div class="summary-label">Pick-up Location</div>
                        <div class="summary-value" id="summaryLocation">Select location</div>
                    </div>
                    <div class="summary-item" onclick="openSearchModal()">
                        <div class="summary-label">Pick-up Date</div>
                        <div class="summary-value" id="summaryPickupDate">18/10/2025</div>
                    </div>
                    <div class="summary-item" onclick="openSearchModal()">
                        <div class="summary-label">Pick-up Time</div>
                        <div class="summary-value" id="summaryPickupTime">15:00</div>
                    </div>
                    <div class="summary-item" onclick="openSearchModal()">
                        <div class="summary-label">Return Date</div>
                        <div class="summary-value" id="summaryReturnDate">20/10/2025</div>
                    </div>
                    <div class="summary-item" onclick="openSearchModal()">
                        <div class="summary-label">Return Time</div>
                        <div class="summary-value" id="summaryReturnTime">19:00</div>
                    </div>
                    <button type="button" class="btn-search" onclick="submitSearch()">
                        <i class="fas fa-search"></i>
                        SEARCH
                    </button>
                </div>
            </div>
        </section>

        <div class="container">
            <div class="filter-section">
                <div style="display:flex; align-items:center; justify-content:space-between; gap:1rem;">
                    <h3>Filters</h3>
                    <div style="display:flex; gap:.5rem; align-items:center;">
                        <small id="filter-count" style="color:#666">Showing 0 cars</small>
                        <button id="resetFiltersBtn" type="button" class="btn-apply-filters" style="background:#eee;color:#333;padding:.4rem .8rem;border-radius:6px;">Reset</button>
                        <button id="applyFiltersBtn" type="button" class="btn-apply-filters">Apply Filters</button>
                    </div>
                </div>
                <form id="filter-form" onsubmit="return false;" style="margin-top:12px; display:flex; gap:12px; align-items:flex-end;">
                    <div class="filter-group" style="flex:1;">
                        <label>Brand</label>
                        <select id="filter-brand" name="brand"><option value="">Any Brand</option></select>
                    </div>
                    <div class="filter-group" style="flex:1;">
                        <label>Color</label>
                        <select id="filter-color" name="color"><option value="">Any Color</option></select>
                    </div>
                    <div class="filter-group" style="width:120px;">
                        <label>Seats</label>
                        <select id="filter-seats" name="seats"><option value="">Any</option><option value="2">2</option><option value="4">4</option><option value="5">5</option><option value="7">7</option></select>
                    </div>
                    <div class="filter-group" style="width:120px;">
                        <label>Year (min)</label>
                        <input id="filter-year" type="number" min="1900" max="2100" placeholder="2020" />
                    </div>
                    <div class="filter-group" style="width:140px;">
                        <label>Price min</label>
                        <input id="filter-price-min" type="number" min="0" placeholder="0" />
                    </div>
                    <div class="filter-group" style="width:140px;">
                        <label>Price max</label>
                        <input id="filter-price-max" type="number" min="0" placeholder="999" />
                    </div>
                </form>
            </div>

            <div class="car-list">
                <!-- Car Cards -->
                <div class="car-card" onclick="window.location.href='car_detail.html?id=1'">
                    <div class="car-image">
                        <i class="fas fa-car car-placeholder-icon"></i>
                        <span class="car-tag">Electric</span>
                    </div>
                    <div class="car-info">
                        <div class="car-header">
                            <h3 class="car-name">Tesla Model 3</h3>
                            <div class="car-price">$15/hour</div>
                        </div>
                        <div class="car-features">
                            <span><i class="fas fa-battery-three-quarters"></i> 350km Range</span>
                            <span><i class="fas fa-bolt"></i> Fast Charging</span>
                            <span><i class="fas fa-user"></i> 5 seats</span>
                        </div>
                        <div class="car-rating">
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star-half"></i>
                            <span>(32 reviews)</span>
                        </div>
                    </div>
                </div>

                <div class="car-card" onclick="window.location.href='car_detail.html?id=2'">
                    <div class="car-image">
                        <i class="fas fa-car car-placeholder-icon"></i>
                        <span class="car-tag">Electric</span>
                    </div>
                    <div class="car-info">
                        <div class="car-header">
                            <h3 class="car-name">Nissan Leaf</h3>
                            <div class="car-price">$12/hour</div>
                        </div>
                        <div class="car-features">
                            <span><i class="fas fa-battery-three-quarters"></i> 300km Range</span>
                            <span><i class="fas fa-bolt"></i> Fast Charging</span>
                            <span><i class="fas fa-user"></i> 5 seats</span>
                        </div>
                        <div class="car-rating">
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star"></i>
                            <i class="far fa-star"></i>
                            <span>(28 reviews)</span>
                        </div>
                    </div>
                </div>

                <!-- Additional car cards for demonstration -->
                <div class="car-card" onclick="window.location.href='car_detail.html?id=3'">
                    <div class="car-image">
                        <i class="fas fa-car car-placeholder-icon"></i>
                        <span class="car-tag">Electric</span>
                    </div>
                    <div class="car-info">
                        <div class="car-header">
                            <h3 class="car-name">BMW i4</h3>
                            <div class="car-price">$18/hour</div>
                        </div>
                        <div class="car-features">
                            <span><i class="fas fa-battery-three-quarters"></i> 400km Range</span>
                            <span><i class="fas fa-bolt"></i> Fast Charging</span>
                            <span><i class="fas fa-user"></i> 5 seats</span>
                        </div>
                        <div class="car-rating">
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star"></i>
                            <span>(45 reviews)</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Search Modal -->
    <div id="searchModal" class="search-modal">
        <div class="search-modal-content">
            <div class="search-modal-header">
                <h3>Search Cars</h3>
                <button class="search-modal-close" onclick="closeSearchModal()">&times;</button>
            </div>
            <div class="search-modal-body">
                <!-- Location -->
                <div class="search-field">
                    <label>
                        <i class="fas fa-map-marker-alt"></i>
                        Pick-up Location
                    </label>
                    <div class="search-input" onclick="toggleLocationDropdown()">
                        <i class="fas fa-map-marker-alt"></i>
                        <span id="selectedLocation">Select location</span>
                    </div>
                    <div class="location-dropdown" id="locationDropdown">
                        <!-- Will be populated by JavaScript -->
                    </div>
                </div>

                <!-- Pick-up Date & Time -->
                <div class="search-field-row">
                    <div class="search-field">
                        <label>
                            <i class="fas fa-calendar"></i>
                            Pick-up Date
                        </label>
                        <div class="search-input" onclick="toggleCalendar('pickup')">
                            <i class="fas fa-calendar"></i>
                            <span id="selectedPickupDate">18/10/2025</span>
                        </div>
                    </div>
                    <div class="search-field">
                        <label>
                            <i class="fas fa-clock"></i>
                            Pick-up Time
                        </label>
                        <div class="search-input" onclick="toggleTimePicker('pickup')">
                            <i class="fas fa-clock"></i>
                            <span id="selectedPickupTime">15:00</span>
                        </div>
                        <div class="time-picker-dropdown" id="pickupTimePicker">
                            <div class="time-picker-label">Choose pick-up time</div>
                            <div class="time-picker-options">
                                <div class="time-option" data-time="06:00">06:00</div>
                                <div class="time-option" data-time="07:00">07:00</div>
                                <div class="time-option" data-time="08:00">08:00</div>
                                <div class="time-option" data-time="09:00">09:00</div>
                                <div class="time-option" data-time="10:00">10:00</div>
                                <div class="time-option" data-time="11:00">11:00</div>
                                <div class="time-option" data-time="12:00">12:00</div>
                                <div class="time-option" data-time="13:00">13:00</div>
                                <div class="time-option" data-time="14:00">14:00</div>
                                <div class="time-option" data-time="15:00">15:00</div>
                                <div class="time-option" data-time="16:00">16:00</div>
                                <div class="time-option" data-time="17:00">17:00</div>
                                <div class="time-option" data-time="18:00">18:00</div>
                                <div class="time-option" data-time="19:00">19:00</div>
                                <div class="time-option" data-time="20:00">20:00</div>
                                <div class="time-option" data-time="21:00">21:00</div>
                                <div class="time-option" data-time="22:00">22:00</div>
                                <div class="time-option" data-time="23:00">23:00</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Return Date & Time -->
                <div class="search-field-row">
                    <div class="search-field">
                        <label>
                            <i class="fas fa-calendar-check"></i>
                            Return Date
                        </label>
                        <div class="search-input" onclick="toggleCalendar('return')">
                            <i class="fas fa-calendar-check"></i>
                            <span id="selectedReturnDate">20/10/2025</span>
                        </div>
                    </div>
                    <div class="search-field">
                        <label>
                            <i class="fas fa-clock"></i>
                            Return Time
                        </label>
                        <div class="search-input" onclick="toggleTimePicker('return')">
                            <i class="fas fa-clock"></i>
                            <span id="selectedReturnTime">19:00</span>
                        </div>
                        <div class="time-picker-dropdown" id="returnTimePicker">
                            <div class="time-picker-label">Choose return time</div>
                            <div class="time-picker-options">
                                <div class="time-option" data-time="06:00">06:00</div>
                                <div class="time-option" data-time="07:00">07:00</div>
                                <div class="time-option" data-time="08:00">08:00</div>
                                <div class="time-option" data-time="09:00">09:00</div>
                                <div class="time-option" data-time="10:00">10:00</div>
                                <div class="time-option" data-time="11:00">11:00</div>
                                <div class="time-option" data-time="12:00">12:00</div>
                                <div class="time-option" data-time="13:00">13:00</div>
                                <div class="time-option" data-time="14:00">14:00</div>
                                <div class="time-option" data-time="15:00">15:00</div>
                                <div class="time-option" data-time="16:00">16:00</div>
                                <div class="time-option" data-time="17:00">17:00</div>
                                <div class="time-option" data-time="18:00">18:00</div>
                                <div class="time-option" data-time="19:00">19:00</div>
                                <div class="time-option" data-time="20:00">20:00</div>
                                <div class="time-option" data-time="21:00">21:00</div>
                                <div class="time-option" data-time="22:00">22:00</div>
                                <div class="time-option" data-time="23:00">23:00</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Calendar Widget -->
                <div class="calendar-widget" id="calendarWidget">
                    <div class="calendar-container">
                        <div class="calendar-header">
                            <button onclick="changeMonth(-1)">&lt;</button>
                            <span id="calendarMonth">October 2025</span>
                            <button onclick="changeMonth(1)">&gt;</button>
                        </div>
                        <div class="calendar-weekdays">
                            <div>Sun</div>
                            <div>Mon</div>
                            <div>Tue</div>
                            <div>Wed</div>
                            <div>Thu</div>
                            <div>Fri</div>
                            <div>Sat</div>
                        </div>
                        <div class="calendar-days" id="calendarDays">
                            <!-- Will be populated by JavaScript -->
                        </div>
                    </div>
                </div>

                <!-- Rental Duration Info -->
                <div class="rental-duration">
                    <i class="fas fa-info-circle"></i>
                    <div>
                        <strong>Rental Duration</strong>
                        <p id="rentalDurationText">2 days 4 hours</p>
                    </div>
                </div>

                <!-- Warning -->
                <div class="rental-warning">
                    <i class="fas fa-exclamation-circle"></i>
                    <p>Minimum rental duration is 1 hour. Same-day rentals are available. To ensure cars are properly prepared and meet environmental standards, please book at least 2 hours in advance.</p>
                </div>

                <!-- Search Button -->
                <button class="btn-search-submit" onclick="submitSearch()">
                    <i class="fas fa-search"></i>
                    Search Cars
                </button>
            </div>
        </div>
    </div>

    <footer class="footer">
        <div class="container">
            <p>&copy; 2025 FEC. All rights reserved.</p>
        </div>
    </footer>

    <!-- Modals -->
    <div id="modal" class="modal-overlay">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal()">&times;</span>
            <h2>LOGIN</h2>
            <form>
                <input type="text" placeholder="Enter Username" required>
                <input type="password" placeholder="Enter Password" required>
                <a href="#">Forgot Password?</a>
                <button type="submit">Login</button>
                <a href="#" onclick="openRegisterModal()">Create Account</a>
            </form>
        </div>
    </div>

    <div id="registerModal" class="modal-overlay">
        <div class="modal-content">
            <span class="close-btn" onclick="closeRegisterModal()">&times;</span>
            <h2>Register</h2>
            <form>
                <input type="text" placeholder="Enter Username" required>
                <input type="email" placeholder="Enter Email" required>
                <input type="password" placeholder="Enter Password" required>
                <input type="password" placeholder="Confirm Password" required>
                <button type="submit">Create Account</button>
            </form>
        </div>
    </div>

    <script>
        // ============= GLOBAL STATE =============
        let currentStationId = null;
        let currentSearchParams = {};

        // ============= SEARCH DATA =============
        const today = new Date();
        const searchData = {
            location: '',
            locationName: '',
            pickupDate: `${today.getFullYear()}-${(today.getMonth() + 1).toString().padStart(2, '0')}-${today.getDate().toString().padStart(2, '0')}`,
            pickupTime: '15:00',
            returnDate: `${today.getFullYear()}-${(today.getMonth() + 1).toString().padStart(2, '0')}-${(today.getDate() + 2).toString().padStart(2, '0')}`,
            returnTime: '19:00',
            currentMonth: today.getMonth(),
            currentYear: today.getFullYear(),
            calendarMode: 'pickup' // 'pickup' or 'return'
        };

        // ============= SEARCH MODAL FUNCTIONS =============
        function openSearchModal() {
            document.getElementById('searchModal').classList.add('active');
            loadLocations();
        }

        function closeSearchModal() {
            document.getElementById('searchModal').classList.remove('active');
            // Close all dropdowns
            document.querySelectorAll('.location-dropdown, .time-picker-dropdown, .calendar-widget').forEach(el => {
                el.classList.remove('active');
            });
        }

        function toggleLocationDropdown() {
            const dropdown = document.getElementById('locationDropdown');
            const isActive = dropdown.classList.toggle('active');
            
            // Close others
            document.querySelectorAll('.time-picker-dropdown, .calendar-widget').forEach(el => {
                el.classList.remove('active');
            });
            
            if (isActive && dropdown.children.length === 0) {
                loadLocations();
            }
        }

        async function loadLocations() {
            const dropdown = document.getElementById('locationDropdown');
            
            try {
                const stations = await window.API.getAllStations(1, 500);
                const stationList = stations.data || stations.items || stations;
                
                if (!stationList || stationList.length === 0) {
                    dropdown.innerHTML = '<div class="location-option" style="color: #999;">No locations available</div>';
                    return;
                }
                
                dropdown.innerHTML = stationList.map(station => {
                    const stationName = station.stationName || station.name || 'Unknown Location';
                    const stationId = station.id || station.stationId;
                    const safeName = stationName.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                    
                    return `
                        <div class="location-option" onclick="selectLocation('${stationId}', '${safeName}')">
                            <i class="fas fa-map-marker-alt"></i>
                            <span>${stationName}</span>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Failed to load locations:', error);
                dropdown.innerHTML = '<div class="location-option" style="color: red; padding: 12px;">Failed to load locations</div>';
            }
        }

        function selectLocation(id, name) {
            searchData.location = id;
            searchData.locationName = name;
            document.getElementById('selectedLocation').textContent = name;
            document.getElementById('summaryLocation').textContent = name;
            document.getElementById('locationDropdown').classList.remove('active');
        }

        function toggleTimePicker(type) {
            const pickerId = type === 'pickup' ? 'pickupTimePicker' : 'returnTimePicker';
            const picker = document.getElementById(pickerId);
            const isActive = picker.classList.toggle('active');
            
            // Close others
            const otherId = type === 'pickup' ? 'returnTimePicker' : 'pickupTimePicker';
            document.getElementById(otherId).classList.remove('active');
            document.getElementById('locationDropdown').classList.remove('active');
            document.getElementById('calendarWidget').classList.remove('active');
            
            // Highlight selected time
            if (isActive) {
                const selectedTime = type === 'pickup' ? searchData.pickupTime : searchData.returnTime;
                picker.querySelectorAll('.time-option').forEach(opt => {
                    opt.classList.toggle('selected', opt.dataset.time === selectedTime);
                });
            }
        }

        function selectTime(type, time) {
            if (type === 'pickup') {
                searchData.pickupTime = time;
                document.getElementById('selectedPickupTime').textContent = time;
                document.getElementById('summaryPickupTime').textContent = time;
                document.getElementById('pickupTimePicker').classList.remove('active');
            } else {
                searchData.returnTime = time;
                document.getElementById('selectedReturnTime').textContent = time;
                document.getElementById('summaryReturnTime').textContent = time;
                document.getElementById('returnTimePicker').classList.remove('active');
            }
            updateRentalDuration();
        }

        function toggleCalendar(mode) {
            const calendar = document.getElementById('calendarWidget');
            searchData.calendarMode = mode;
            
            const isActive = calendar.classList.toggle('active');
            
            // Close others
            document.querySelectorAll('.location-dropdown, .time-picker-dropdown').forEach(el => {
                el.classList.remove('active');
            });
            
            if (isActive) {
                renderCalendar();
            }
        }

        function changeMonth(delta) {
            searchData.currentMonth += delta;
            if (searchData.currentMonth > 11) {
                searchData.currentMonth = 0;
                searchData.currentYear++;
            } else if (searchData.currentMonth < 0) {
                searchData.currentMonth = 11;
                searchData.currentYear--;
            }
            renderCalendar();
        }

        function renderCalendar() {
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 
                              'July', 'August', 'September', 'October', 'November', 'December'];
            
            document.getElementById('calendarMonth').textContent = 
                `${monthNames[searchData.currentMonth]} ${searchData.currentYear}`;
            
            const firstDay = new Date(searchData.currentYear, searchData.currentMonth, 1);
            const lastDay = new Date(searchData.currentYear, searchData.currentMonth + 1, 0);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            let html = '';
            
            // Empty cells for days before month starts
            for (let i = 0; i < firstDay.getDay(); i++) {
                html += '<div class="calendar-day"></div>';
            }
            
            // Days of month
            for (let day = 1; day <= lastDay.getDate(); day++) {
                // Create dateStr directly without Date object to avoid timezone issues
                const dateStr = `${searchData.currentYear}-${(searchData.currentMonth + 1).toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
                
                // Use Date object only for comparison
                const date = new Date(searchData.currentYear, searchData.currentMonth, day);
                const isToday = date.toDateString() === today.toDateString();
                const isPast = date < today;
                const isSelected = dateStr === (searchData.calendarMode === 'pickup' ? searchData.pickupDate : searchData.returnDate);
                
                let classes = ['calendar-day'];
                if (isPast) classes.push('disabled');
                if (isToday) classes.push('today');
                if (isSelected) classes.push('selected');
                
                html += `<div class="${classes.join(' ')}" 
                             onclick="${isPast ? '' : `selectDate('${dateStr}')`}">
                            ${day}
                         </div>`;
            }
            
            document.getElementById('calendarDays').innerHTML = html;
        }

        function selectDate(dateStr) {
            // Parse date correctly to avoid timezone issues
            const [year, month, day] = dateStr.split('-').map(Number);
            const formattedDate = `${day.toString().padStart(2, '0')}/${month.toString().padStart(2, '0')}/${year}`;
            
            if (searchData.calendarMode === 'pickup') {
                searchData.pickupDate = dateStr;
                document.getElementById('selectedPickupDate').textContent = formattedDate;
                document.getElementById('summaryPickupDate').textContent = formattedDate;
                
                // Only auto-adjust return date if return datetime is before pickup datetime
                const pickupDateTime = new Date(`${dateStr}T${searchData.pickupTime}`);
                const returnDateTime = new Date(`${searchData.returnDate}T${searchData.returnTime}`);
                
                if (returnDateTime < pickupDateTime) {
                    // Set return date same as pickup date, but time +2 hours
                    searchData.returnDate = dateStr;
                    const pickupHour = parseInt(searchData.pickupTime.split(':')[0]);
                    const newReturnHour = Math.min(pickupHour + 2, 23);
                    searchData.returnTime = `${newReturnHour.toString().padStart(2, '0')}:00`;
                    
                    document.getElementById('selectedReturnDate').textContent = formattedDate;
                    document.getElementById('summaryReturnDate').textContent = formattedDate;
                    document.getElementById('selectedReturnTime').textContent = searchData.returnTime;
                    document.getElementById('summaryReturnTime').textContent = searchData.returnTime;
                }
            } else {
                searchData.returnDate = dateStr;
                document.getElementById('selectedReturnDate').textContent = formattedDate;
                document.getElementById('summaryReturnDate').textContent = formattedDate;
            }
            
            document.getElementById('calendarWidget').classList.remove('active');
            updateRentalDuration();
        }

        function updateRentalDuration() {
            const pickup = new Date(`${searchData.pickupDate}T${searchData.pickupTime}`);
            const returnTime = new Date(`${searchData.returnDate}T${searchData.returnTime}`);
            const diffMs = returnTime - pickup;
            const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
            const days = Math.floor(diffHours / 24);
            const hours = diffHours % 24;
            
            let durationText = '';
            if (diffHours < 0) {
                durationText = 'Invalid duration';
            } else if (diffHours === 0) {
                durationText = 'Less than 1 hour';
            } else {
                if (days > 0) durationText += `${days} day${days > 1 ? 's' : ''} `;
                if (hours > 0) durationText += `${hours} hour${hours > 1 ? 's' : ''}`;
            }
            
            document.getElementById('rentalDurationText').textContent = durationText.trim() || '0 hours';
        }

        function updateSummaryBar() {
            // Format dates from YYYY-MM-DD to DD/MM/YYYY
            const formatDate = (dateStr) => {
                const [year, month, day] = dateStr.split('-');
                return `${day}/${month}/${year}`;
            };

            // Update summary bar
            document.getElementById('summaryLocation').textContent = searchData.locationName || 'Select location';
            document.getElementById('summaryPickupDate').textContent = formatDate(searchData.pickupDate);
            document.getElementById('summaryPickupTime').textContent = searchData.pickupTime;
            document.getElementById('summaryReturnDate').textContent = formatDate(searchData.returnDate);
            document.getElementById('summaryReturnTime').textContent = searchData.returnTime;

            // Update modal fields
            document.getElementById('selectedLocation').textContent = searchData.locationName || 'Select location';
            document.getElementById('selectedPickupDate').textContent = formatDate(searchData.pickupDate);
            document.getElementById('selectedPickupTime').textContent = searchData.pickupTime;
            document.getElementById('selectedReturnDate').textContent = formatDate(searchData.returnDate);
            document.getElementById('selectedReturnTime').textContent = searchData.returnTime;
        }

        function submitSearch() {
            if (!searchData.location) {
                alert('Please select a pick-up location');
                return;
            }
            
            // Validate datetime
            const pickupDateTime = new Date(`${searchData.pickupDate}T${searchData.pickupTime}`);
            const returnDateTime = new Date(`${searchData.returnDate}T${searchData.returnTime}`);
            
            if (returnDateTime <= pickupDateTime) {
                alert('Return date and time must be after pick-up date and time.\n\nPlease select a later return time or date.');
                return;
            }
            
            // Check minimum rental duration (at least 1 hour)
            const diffMs = returnDateTime - pickupDateTime;
            const diffHours = diffMs / (1000 * 60 * 60);
            
            if (diffHours < 1) {
                alert('Minimum rental duration is 1 hour.\n\nPlease adjust your return time.');
                return;
            }
            
            // Save rental context
            const rentalContext = {
                stationId: searchData.location,
                stationName: searchData.locationName,
                pickupDate: searchData.pickupDate,
                pickupTime: searchData.pickupTime,
                returnDate: searchData.returnDate,
                returnTime: searchData.returnTime,
                createdAt: new Date().toISOString()
            };
            
            try {
                localStorage.setItem('rentalContext', JSON.stringify(rentalContext));
            } catch (e) {
                console.error('Failed to save rental context:', e);
            }
            
            // Update URL and reload cars
            const params = new URLSearchParams({
                location: searchData.location,
                'pickup-date': searchData.pickupDate,
                'pickup-time': searchData.pickupTime,
                'return-date': searchData.returnDate,
                'return-time': searchData.returnTime
            });
            
            window.location.href = `car_list_page.html?${params.toString()}`;
        }

        // Add click handlers to time options
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('time-option')) {
                const time = e.target.dataset.time;
                const picker = e.target.closest('.time-picker-dropdown');
                const type = picker.id === 'pickupTimePicker' ? 'pickup' : 'return';
                selectTime(type, time);
            }
        });

        // Close dropdowns when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.search-field') && !e.target.closest('.calendar-widget')) {
                document.querySelectorAll('.location-dropdown, .time-picker-dropdown, .calendar-widget').forEach(el => {
                    el.classList.remove('active');
                });
            }
            
            // Close modal when clicking on overlay
            if (e.target.id === 'searchModal') {
                closeSearchModal();
            }
            
            // Close calendar when clicking on overlay
            if (e.target.id === 'calendarWidget') {
                document.getElementById('calendarWidget').classList.remove('active');
            }
        });

        // ============= NOTIFICATION =============
        function showNotification(message, type = 'success') {
            const existingNotifications = document.querySelectorAll('.notification');
            existingNotifications.forEach(notification => notification.remove());

            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <span>${message}</span>
                <span class="close-btn" onclick="this.parentElement.remove()">&times;</span>
            `;

            document.body.appendChild(notification);
            setTimeout(() => notification.classList.add('show'), 100);
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.classList.remove('show');
                    setTimeout(() => notification.remove(), 300);
                }
            }, 5000);
        }

        // ============= AUTH FUNCTIONS =============
        function checkAuthStatus() {
            const token = localStorage.getItem('token');
            const loginBtn = document.getElementById('loginBtn');
            const userMenu = document.getElementById('userMenu');
            const userEmail = document.getElementById('userEmail');
            
            if (token && token !== 'null' && token !== '') {
                if (loginBtn) loginBtn.style.display = 'none';
                if (userMenu) userMenu.style.display = 'block';
                
                const savedEmail = localStorage.getItem('userEmail');
                if (savedEmail && userEmail) {
                    userEmail.textContent = savedEmail;
                } else if (userEmail) {
                    userEmail.textContent = 'User Account';
                }
            } else {
                localStorage.removeItem('token');
                localStorage.removeItem('userEmail');
                
                if (loginBtn) loginBtn.style.display = 'inline-block';
                if (userMenu) userMenu.style.display = 'none';
            }
        }

        function toggleUserMenu() {
            const dropdown = document.getElementById('userDropdown');
            dropdown.classList.toggle('show');
        }

        function openUserProfile() {
            document.getElementById('userDropdown').classList.remove('show');
            const token = localStorage.getItem('token');
            if (!token || token === 'null' || token === '') {
                showNotification('⚠️ Vui lòng đăng nhập để xem profile!', 'error');
                return;
            }
            window.location.href = 'user_profile.html';
        }

        function logout() {
            document.getElementById('userDropdown').classList.remove('show');
            localStorage.removeItem('token');
            localStorage.removeItem('userEmail');
            checkAuthStatus();
            showNotification('👋 Bạn đã đăng xuất thành công!', 'success');
        }

        function openModal() {
            document.getElementById("modal").style.display = "flex";
        }

        function closeModal() {
            document.getElementById("modal").style.display = "none";
        }

        function openRegisterModal() {
            closeModal();
            document.getElementById("registerModal").style.display = "flex";
        }

        function closeRegisterModal() {
            document.getElementById("registerModal").style.display = "none";
        }

        function toggleMobileMenu() {
            const sidebar = document.querySelector('.sidebar');
            const overlay = document.querySelector('.overlay');
            
            if (sidebar && sidebar.classList.contains('active')) {
                sidebar.classList.remove('active');
                if (overlay) overlay.classList.remove('active');
                document.body.style.overflow = 'auto';
            } else if (sidebar) {
                sidebar.classList.add('active');
                if (overlay) overlay.classList.add('active');
                document.body.style.overflow = 'hidden';
            }
        }

        // ============= STATION DROPDOWN =============
        // DEPRECATED: Old dropdown population (replaced by search module)
        // The old form with <select id="location"> has been removed
        // Stations are now loaded by modules/search.js in the search modal
        /*
        async function populateStationDropdown() {
            const dropdown = document.getElementById('location');
            if (!dropdown) {
                console.error('Station dropdown not found');
                return;
            }

            console.log('📍 Populating station dropdown...');

            try {
                if (!window.API || typeof window.API.getAllStations !== 'function') {
                    console.error('window.API.getAllStations is not available');
                    showNotification('❌ API not loaded', 'error');
                    return;
                }

                const stations = await window.API.getAllStations();
                console.log('✅ Stations loaded:', stations.length);

                dropdown.innerHTML = '<option value="">Select location</option>';

                stations.forEach(station => {
                    const id = station.id || station.Id || station.stationId;
                    const name = station.name || station.Name || station.stationName;

                    if (!id || !name) return;

                    const option = document.createElement('option');
                    option.value = id;
                    option.textContent = name;
                    dropdown.appendChild(option);
                });

                // Set dropdown to URL param if present
                const params = new URLSearchParams(window.location.search);
                const urlStationId = params.get('location');
                if (urlStationId) {
                    dropdown.value = urlStationId;
                    console.log('🎯 Set dropdown to URL station:', urlStationId);
                }

                if (stations.length === 0) {
                    showNotification('⚠️ No stations available', 'error');
                }
            } catch (error) {
                console.error('❌ Error loading stations:', error);
                showNotification('❌ Failed to load stations', 'error');
            }
        }
        */

        // ============= LOAD CARS BY STATION =============
        async function loadCarsByStation(stationId) {
            if (!stationId) {
                console.warn('⚠️ No stationId provided');
                displayNoCars('Please select a location to view available cars');
                return;
            }

            console.log('🚗 Loading cars for station:', stationId);
            currentStationId = stationId;

            const carListContainer = document.querySelector('.car-list');
            if (!carListContainer) {
                console.error('Car list container not found');
                return;
            }

            // Show loading
            carListContainer.innerHTML = '<div class="loading">Loading available cars...</div>';

            try {
                if (!window.API || typeof window.API.getAvailableCarsByStation !== 'function') {
                    console.error('window.API.getAvailableCarsByStation is not available');
                    displayNoCars('API not available');
                    return;
                }

                const cars = await window.API.getAvailableCarsByStation(stationId);
                console.log('✅ Cars loaded:', cars.length);

                if (!cars || cars.length === 0) {
                    displayNoCars('No cars available at this location');
                    return;
                }

                // persist loaded cars so filters can operate client-side without reloading
                try { window._loadedCars = Array.isArray(cars) ? cars.slice() : []; } catch(e) { window._loadedCars = []; }

                // build filter dropdowns
                buildFilterOptions(window._loadedCars || []);

                displayCars(cars);
                const fc = document.getElementById('filter-count'); if (fc) fc.textContent = `Showing ${ (window._loadedCars||[]).length } car${ (window._loadedCars||[]).length===1?'':'s'}`;
            } catch (error) {
                console.error('❌ Error loading cars:', error);
                displayNoCars('Failed to load cars. Please try again.');
                showNotification('❌ Failed to load cars', 'error');
            }
        }

        // ============= DISPLAY FUNCTIONS =============
        function displayCars(cars) {
            const carListContainer = document.querySelector('.car-list');
            if (!carListContainer) return;

            carListContainer.innerHTML = '';

            cars.forEach(car => {
                const carCard = createCarCard(car);
                carListContainer.appendChild(carCard);
            });
        }

        // ============= FILTERS (client-side) =============
        function applyFilters() {
            const cars = window._loadedCars || [];
            if (!cars.length) return;
            const brand = (document.getElementById('filter-brand')||{}).value || '';
            const color = (document.getElementById('filter-color')||{}).value || '';
            const seats = parseInt((document.getElementById('filter-seats')||{}).value || '0',10) || 0;
            const yearMin = parseInt((document.getElementById('filter-year')||{}).value || '0',10) || 0;
            const priceMin = parseFloat((document.getElementById('filter-price-min')||{}).value || '0') || 0;
            const priceMax = parseFloat((document.getElementById('filter-price-max')||{}).value || '0') || 0;

            const filtered = cars.filter(c => {
                const carBrand = (c.brand || c.Brand || c.make || '').toString().trim();
                const carColor = (c.color || c.Color || '').toString().trim();
                const carSeats = parseInt(c.seats || c.Seats || 0,10) || 0;
                const carYear = parseInt(c.year || c.Year || 0,10) || 0;
                const carPrice = parseFloat(c.rentalPricePerHour || c.pricePerHour || c.PricePerHour || 0) || 0;

                if (brand && brand.toLowerCase() !== carBrand.toLowerCase()) return false;
                if (color && color.toLowerCase() !== carColor.toLowerCase()) return false;
                if (seats && carSeats !== seats) return false;
                if (yearMin && carYear < yearMin) return false;
                if (priceMin && carPrice < priceMin) return false;
                if (priceMax && priceMax > 0 && carPrice > priceMax) return false;

                return true;
            });

            displayCars(filtered);
            const fc = document.getElementById('filter-count'); if (fc) fc.textContent = `Showing ${filtered.length} car${filtered.length===1?'':'s'}`;
        }

        function resetFilters() {
            const form = document.getElementById('filter-form');
            if (form) form.reset();
            displayCars(window._loadedCars || []);
            const fc = document.getElementById('filter-count'); if (fc) fc.textContent = `Showing ${ (window._loadedCars||[]).length } car${ (window._loadedCars||[]).length===1?'':'s'}`;
        }

        // Build brand/color options based on loaded cars
        function buildFilterOptions(cars) {
            const brandSet = new Set();
            const colorSet = new Set();

            cars.forEach(c => {
                const b = (c.brand || c.Brand || '').toString().trim();
                const col = (c.color || c.Color || '').toString().trim();
                if (b) brandSet.add(b);
                if (col) colorSet.add(col);
            });

            const brandSel = document.getElementById('filter-brand');
            const colorSel = document.getElementById('filter-color');

            if (brandSel) {
                brandSel.innerHTML = '<option value="">Any Brand</option>' + Array.from(brandSet).sort().map(b => `<option value="${b}">${b}</option>`).join('');
            }
            if (colorSel) {
                colorSel.innerHTML = '<option value="">Any Color</option>' + Array.from(colorSet).sort().map(c => `<option value="${c}">${c}</option>`).join('');
            }
        }

        function createCarCard(car) {
            const div = document.createElement('div');
            div.className = 'car-card';
            div.onclick = () => {
                // Debug: Log current searchData
                console.log('🚗 Clicking car, current searchData:', searchData);
                
                // Save rental context before navigating
                saveRentalContext();
                window.location.href = `car_detail.html?id=${car.id || car.carId}`;
            };

            const id = car.id || car.carId || car.Id;
            // Prefer Brand + Model when available (support multiple casing)
            const brand = car.brand || car.Brand || car.make || car.Make || '';
            const model = car.model || car.Model || car.modelName || car.ModelName || '';
            const nameFallback = car.name || car.carName || car.Name || 'Unknown Car';
            const displayName = (brand && model) ? `${brand} ${model}` : (brand ? `${brand} ${model}`.trim() : nameFallback);
            const pricePerHour = car.rentalPricePerHour || car.pricePerHour || car.PricePerHour || 0;
            const color = car.color || car.Color || 'Unknown';
            const year = car.year || car.Year || '';
            const seats = car.seats || car.Seats || 5;
            const imageUrl = car.imageUrl || car.ImageUrl || '';
            const rating = car.rating || car.Rating || 4.5;
            const reviewCount = car.reviewCount || car.ReviewCount || 0;

            // Use car icon if no image URL
            const imageHtml = imageUrl ? 
                `<img src="${imageUrl}" alt="${name}" onerror="this.parentElement.innerHTML='<i class=\\'fas fa-car car-placeholder-icon\\'></i>'" />` :
                `<i class="fas fa-car car-placeholder-icon"></i>`;

            div.innerHTML = `
                <div class="car-image">
                    ${imageHtml}
                    <span class="car-tag">Electric</span>
                </div>
                <div class="car-info">
                    <div class="car-header">
                        <h3 class="car-name">${displayName}</h3>
                        <div class="car-price">$${pricePerHour}/hour</div>
                    </div>
                    <div class="car-features">
                        <span><i class="fas fa-fill-drip"></i> ${color}</span>
                        <span><i class="fas fa-calendar-alt"></i> ${year}</span>
                        <span><i class="fas fa-user"></i> ${seats} seats</span>
                    </div>
                    <div class="car-rating">
                        ${generateStars(rating)}
                        <span>(${reviewCount} reviews)</span>
                    </div>
                </div>
            `;

            return div;
        }

        function generateStars(rating) {
            let stars = '';
            const fullStars = Math.floor(rating);
            const hasHalfStar = rating % 1 >= 0.5;

            for (let i = 0; i < fullStars; i++) {
                stars += '<i class="fas fa-star"></i>';
            }
            if (hasHalfStar) {
                stars += '<i class="fas fa-star-half"></i>';
            }
            const emptyStars = 5 - Math.ceil(rating);
            for (let i = 0; i < emptyStars; i++) {
                stars += '<i class="far fa-star"></i>';
            }
            return stars;
        }

        function displayNoCars(message) {
            const carListContainer = document.querySelector('.car-list');
            if (!carListContainer) return;

            carListContainer.innerHTML = `
                <div class="no-cars-message">
                    <i class="fas fa-car" style="font-size: 48px; color: #ccc; margin-bottom: 16px;"></i>
                    <p>${message}</p>
                </div>
            `;
        }

        // ============= RENTAL CONTEXT =============
        // Save rental context from searchData (used by search module)
        function saveRentalContext() {
            // Validate that we have essential data
            if (!searchData.location) {
                console.warn('⚠️ Cannot save rental context: missing location');
                return;
            }

            const rentalContext = {
                stationId: searchData.location,
                stationName: searchData.locationName || 'Unknown Location',
                pickupDate: searchData.pickupDate,
                pickupTime: searchData.pickupTime,
                returnDate: searchData.returnDate,
                returnTime: searchData.returnTime,
                createdAt: new Date().toISOString()
            };
            
            try {
                localStorage.setItem('rentalContext', JSON.stringify(rentalContext));
                console.log('💾 Rental context saved:', rentalContext);
            } catch (e) {
                console.error('Failed to save rental context:', e);
            }
        }

        // ============= SEARCH FORM =============
        // NOTE: Search functionality now handled by search module (modules/search.js)
        // Old form-based search has been replaced with new search bar + modal

        // ============= INITIALIZATION =============
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('🚀 Car list page initializing...');

            // Check auth
            checkAuthStatus();

            // DEPRECATED: Old station dropdown population (replaced by search module)
            // await populateStationDropdown();

            // Get URL parameters
            const params = new URLSearchParams(window.location.search);
            const stationId = params.get('location');
            const pickupDate = params.get('pickup-date');
            const pickupTime = params.get('pickup-time');
            const returnDate = params.get('return-date');
            const returnTime = params.get('return-time');

            console.log('🔗 URL Parameters:', { stationId, pickupDate, pickupTime, returnDate, returnTime });

            // Update searchData from URL params or rentalContext
            if (stationId) {
                searchData.location = stationId;
                
                // Try to get station name from rentalContext first
                try {
                    const rentalContext = JSON.parse(localStorage.getItem('rentalContext') || '{}');
                    if (rentalContext.stationName && rentalContext.stationId === stationId) {
                        searchData.locationName = rentalContext.stationName;
                    }
                } catch (e) {
                    console.error('Failed to load rentalContext:', e);
                }
                
                // If not found, try to get from API (after stations are loaded)
                if (!searchData.locationName) {
                    setTimeout(async () => {
                        try {
                            const stations = await window.API.getAllStations(1, 500);
                            const stationList = stations.data || stations.items || stations;
                            const station = stationList.find(s => s.id == stationId || s.stationId == stationId);
                            if (station) {
                                searchData.locationName = station.stationName || station.name || 'Unknown Location';
                                updateSummaryBar();
                            }
                        } catch (e) {
                            console.error('Failed to load station name:', e);
                        }
                    }, 500);
                }
            }
            if (pickupDate) searchData.pickupDate = pickupDate;
            if (pickupTime) searchData.pickupTime = pickupTime;
            if (returnDate) searchData.returnDate = returnDate;
            if (returnTime) searchData.returnTime = returnTime;

            // Update summary bar with search data
            updateSummaryBar();

            // Load cars if stationId provided
            if (stationId) {
                await loadCarsByStation(stationId);
            } else {
                displayNoCars('Please select a location to view available cars');
            }

            // Attach search form handler - REMOVED since we use new search bar
            // const searchForm = document.getElementById('car-search-form');
            // if (searchForm) {
            //     searchForm.addEventListener('submit', handleSearchFormSubmit);
            //     console.log('✅ Search form handler attached');
            // }

            // Wire up filter buttons (client-side)
            const applyBtn = document.getElementById('applyFiltersBtn');
            const resetBtn = document.getElementById('resetFiltersBtn');
            if (applyBtn) applyBtn.addEventListener('click', applyFilters);
            if (resetBtn) resetBtn.addEventListener('click', resetFilters);

            // Auto-apply filters when user changes any filter control (debounced)
            const debounce = (fn, wait) => {
                let t;
                return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), wait); };
            };

            const autoApply = debounce(() => { applyFilters(); }, 250);

            // List of filter control ids
            const filterIds = ['filter-brand','filter-color','filter-seats','filter-year','filter-price-min','filter-price-max'];
            filterIds.forEach(id => {
                const el = document.getElementById(id);
                if (!el) return;
                // use input event for text/number, change for select
                const ev = (el.tagName === 'SELECT' ? 'change' : 'input');
                el.addEventListener(ev, autoApply);
            });

            // Hide the Apply button because filters auto-apply
            if (applyBtn) applyBtn.style.display = 'none';

            // Close dropdown when clicking outside
            document.addEventListener('click', function(event) {
                const userMenu = document.querySelector('.user-menu');
                const dropdown = document.getElementById('userDropdown');
                
                if (userMenu && !userMenu.contains(event.target)) {
                    dropdown.classList.remove('show');
                }
            });

            // ========== LOGIN FORM HANDLER ==========
            const loginForm = document.getElementById('loginForm');
            if (loginForm) {
                loginForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    const email = document.getElementById('loginEmail').value.trim();
                    const password = document.getElementById('loginPassword').value;
                    
                    if (!email || !password) {
                        showNotification('❌ Please enter email and password!', 'error');
                        return;
                    }
                    
                    console.log('Attempting login with email:', email);
                    
                    try {
                        const response = await window.API.login(email, password);
                        
                        if (response.token) {
                            localStorage.setItem('token', response.token);
                            if (response.user && response.user.id) {
                                localStorage.setItem('userId', response.user.id);
                            }
                            if (response.user && response.user.email) {
                                localStorage.setItem('userEmail', response.user.email);
                            }
                            
                            showNotification('🎉 Login successful!', 'success');
                            closeModal();
                            checkAuthStatus();
                            loginForm.reset();
                        } else {
                            showNotification('⚠️ Invalid server response.', 'error');
                        }
                    } catch (error) {
                        console.error('Login error:', error);
                        const errorMsg = error.message || 'Login failed';
                        showNotification(`❌ ${errorMsg}`, 'error');
                    }
                });
            }

            // ========== REGISTER FORM HANDLER ==========
            const registerForm = document.getElementById('registerForm');
            if (registerForm) {
                registerForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    const username = document.getElementById('registerUsername').value.trim();
                    const email = document.getElementById('registerEmail').value.trim();
                    const phoneNumber = document.getElementById('registerPhone').value.trim();
                    const password = document.getElementById('registerPassword').value;
                    
                    try {
                        const response = await window.API.register(username, email, phoneNumber, password);
                        showNotification('🎊 Registration successful!', 'success');
                        closeRegisterModal();
                        setTimeout(() => {
                            openModal();
                            showNotification('💡 You can login now!', 'success');
                        }, 2000);
                    } catch (error) {
                        console.error('Register error:', error);
                        const errorMsg = error.message || 'Registration failed';
                        showNotification(`❌ ${errorMsg}`, 'error');
                    }
                });
            }

            console.log('✅ Car list page initialized');
        });
    </script>
</body>

</html>
