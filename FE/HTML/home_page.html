<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>FEC - Electric Car Rental</title>
    <link rel="stylesheet" href="../style.css" />
    <link rel="stylesheet" href="../CSS/shared.css" />
    <link rel="stylesheet" href="../CSS/home_page.css" />
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="../api.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
</head>

<body>
    <header class="header">
        <div class="container header-container">
            <div class="logo">
                <a href="home_page.html">FEC</a>
            </div>
            <button class="mobile-menu-btn" onclick="toggleMobileMenu()">
                <i class="fas fa-bars"></i>
            </button>
            <nav class="nav">
                <div class="navbar-right">
                    <!-- Login button for non-authenticated users -->
                    <button id="loginBtn" onclick="openModal()" class="login-nav-btn">Login</button>
                    
                    <!-- User menu for authenticated users -->
                    <div id="userMenu" class="user-menu" style="display: none;">
                        <button class="user-menu-btn" onclick="toggleUserMenu()">
                            <i class="fas fa-user-circle"></i>
                            <i class="fas fa-chevron-down"></i>
                        </button>
                        <div id="userDropdown" class="user-dropdown">
                            <div class="dropdown-header">
                                <i class="fas fa-user-circle"></i>
                                <span id="userEmail">User Account</span>
                            </div>
                            <hr>
                            <a href="#" onclick="openUserProfile()">
                                <i class="fas fa-user-cog"></i> User Profile
                            </a>
                            <a href="#" onclick="openBookingHistory()">
                                <i class="fas fa-history"></i> Booking History
                            </a>
                            <a href="#" onclick="logout()">
                                <i class="fas fa-sign-out-alt"></i> Logout
                            </a>
                        </div>
                    </div>
                </div>
            </nav>
        </div>
    </header>

    <!-- Hero Slideshow Section with Overlay Search -->
    <section class="hero-slideshow">
        <div class="slideshow-container">
            <!-- Slides sẽ được tự động load từ folder Picture -->
            <div class="slide fade active">
                <img src="../Picture/E car 1.jpg" alt="Electric Car 1">
            </div>
            <div class="slide fade">
                <img src="../Picture/E car 3.png" alt="Electric Car 3">
                <img src="../Picture/E car 2.png" alt="Electric Car 2">
            </div>
            <div class="slide fade">

                <img src="../Picture/E car 2.png" alt="Electric Car 2">
            </div>
        </div>
        
        <!-- Search Form Overlay - Đặt trên slideshow -->
        <div class="search-form-overlay" id="searchFormOverlay">
            <div class="container">
                <div class="search-form-wrapper">
                    <h2>Find Your Perfect Rental Car</h2>
                <form id="car-search-form" action="car_list_page.html" method="get">
                    <div class="search-grid">
                        <div class="form-group">
                            <label for="location">
                                <i class="fas fa-map-marker-alt"></i>
                                Pick-up Location
                            </label>
                            <select id="location" name="location" required>
                                <option value="">Select location</option>
                                <option value="district1">District 1</option>
                                <option value="district2">District 2</option>
                                <option value="district3">District 3</option>
                                <option value="district4">District 4</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="pickup-date">
                                <i class="fas fa-calendar"></i>
                                Pick-up Date
                            </label>
                            <input type="date" id="pickup-date" name="pickup-date" required />
                        </div>
                        <div class="form-group">
                            <label for="pickup-time">
                                <i class="fas fa-clock"></i>
                                Pick-up Time
                            </label>
                            <select id="pickup-time" name="pickup-time" required>
                                <option value="">Select hour</option>
                                <option value="06:00">06:00</option>
                                <option value="07:00">07:00</option>
                                <option value="08:00">08:00</option>
                                <option value="09:00">09:00</option>
                                <option value="10:00">10:00</option>
                                <option value="11:00">11:00</option>
                                <option value="12:00">12:00</option>
                                <option value="13:00">13:00</option>
                                <option value="14:00">14:00</option>
                                <option value="15:00">15:00</option>
                                <option value="16:00">16:00</option>
                                <option value="17:00">17:00</option>
                                <option value="18:00">18:00</option>
                                <option value="19:00">19:00</option>
                                <option value="20:00">20:00</option>
                                <option value="21:00">21:00</option>
                                <option value="22:00">22:00</option>
                                <option value="23:00">23:00</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="return-date">
                                <i class="fas fa-calendar-check"></i>
                                Return Date
                            </label>
                            <input type="date" id="return-date" name="return-date" required />
                        </div>
                        <div class="form-group">
                            <label for="return-time">
                                <i class="fas fa-clock"></i>
                                Return Time
                            </label>
                            <select id="return-time" name="return-time" required>
                                <option value="">Select hour</option>
                                <option value="06:00">06:00</option>
                                <option value="07:00">07:00</option>
                                <option value="08:00">08:00</option>
                                <option value="09:00">09:00</option>
                                <option value="10:00">10:00</option>
                                <option value="11:00">11:00</option>
                                <option value="12:00">12:00</option>
                                <option value="13:00">13:00</option>
                                <option value="14:00">14:00</option>
                                <option value="15:00">15:00</option>
                                <option value="16:00">16:00</option>
                                <option value="17:00">17:00</option>
                                <option value="18:00">18:00</option>
                                <option value="19:00">19:00</option>
                                <option value="20:00">20:00</option>
                                <option value="21:00">21:00</option>
                                <option value="22:00">22:00</option>
                                <option value="23:00">23:00</option>
                            </select>
                        </div>
                        <button type="submit" class="btn-search">
                            <i class="fas fa-search"></i>
                            SEARCH
                        </button>
                    </div>
                </form>
                </div>
            </div>
        </div>
    </section>

    <!-- Car Models Section -->
    <section class="car-section" data-type="models">
        <div class="container">
            <div class="car-section-header">
                <h2>Our Electric Car Models</h2>
            </div>
            <div class="car-grid">
                <!-- Car Cards -->
                <div class="car-card">
                    <div class="car-image">
                        <img src="assets/placeholder.jpg" alt="Tesla Model 3" />
                        <span class="car-tag">Electric</span>
                    </div>
                    <div class="car-info">
                        <div class="car-header">
                            <h3 class="car-name">Tesla Model 3</h3>
                        </div>
                        <div class="car-features">
                            <span><i class="fas fa-battery-three-quarters"></i> 350km Range</span>
                            <span><i class="fas fa-bolt"></i> Fast Charging</span>
                            <span><i class="fas fa-user"></i> 5 seats</span>
                        </div>
                        <div class="car-description">
                            <p>Premium electric sedan with cutting-edge technology and impressive performance.</p>
                        </div>
                    </div>
                </div>
                <!-- More car cards... -->
            </div>
        </div>
    </section>

    <footer class="footer">
        <div class="container">
            <p>&copy; 2025 FEC. All rights reserved.</p>
        </div>
    </footer>

    <!-- Login Modal -->
    <div id="modal" class="modal-overlay">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal()">&times;</span>
            <h2>LOGIN</h2>
            <form id="loginForm">
                <input type="email" id="loginEmail" placeholder="Enter Email" required>
                <input type="password" id="loginPassword" placeholder="Enter Password" required>
                <a href="#">Forgot Password?</a>
                <button type="submit">Login</button>
                <a href="#" onclick="openRegisterModal()">Create Account</a>
            </form>
        </div>
    </div>

    <!-- Register Modal -->
    <div id="registerModal" class="modal-overlay">
        <div class="modal-content">
            <span class="close-btn" onclick="closeRegisterModal()">&times;</span>
            <h2>Register</h2>
            <form id="registerForm">
                <input type="text" id="registerUsername" placeholder="Username (min 3 characters)" required>
                <input type="email" id="registerEmail" placeholder="Email" required>
                <input type="tel" id="registerPhone" placeholder="Phone Number (10-11 digits)" required pattern="[0-9]{10,11}">
                <input type="password" id="registerPassword" placeholder="Password (A-Z, a-z, 0-9, special chars)" required minlength="6">
                <small class="password-hint">
                    Password must include: Uppercase, lowercase, number and special character
                </small>
                <button type="submit">Create Account</button>
            </form>
        </div>
    </div>

    <script>
        // ========================================
        // SLIDESHOW FUNCTIONS
        // ======================================== 
        
        /**
         * slideIndex: Vị trí slide hiện tại (bắt đầu từ 0)
         * slides: Danh sách tất cả các slide
         * dots: Danh sách các dot indicators
         * autoSlideTimer: Timer cho việc tự động chuyển slide
         */
        let slideIndex = 0;
        let autoSlideTimer;
        const SLIDE_INTERVAL = 6000; // 10 giây

        /**
         * Hàm khởi động slideshow
         * - Tự động hiển thị slide đầu tiên
         * - Bắt đầu timer tự động chuyển slide
         */
        function initSlideshow() {
            showSlide(slideIndex);
            startAutoSlide();
        }

        /**
         * Hiển thị slide tại vị trí index
         * @param {number} index - Vị trí slide cần hiển thị
         */
        function showSlide(index) {
            const slides = document.querySelectorAll('.slide');
            const dots = document.querySelectorAll('.dot');
            
            // Nếu không có slide nào, thoát
            if (slides.length === 0) return;
            
            // Xử lý vòng lặp: nếu vượt quá cuối, quay về đầu
            if (index >= slides.length) {
                slideIndex = 0;
            }
            // Nếu về trước đầu, quay về cuối
            if (index < 0) {
                slideIndex = slides.length - 1;
            }
            
            // Ẩn tất cả slides
            slides.forEach(slide => {
                slide.classList.remove('active');
            });
            
            // Bỏ active tất cả dots
            dots.forEach(dot => {
                dot.classList.remove('active');
            });
            
            // Hiển thị slide hiện tại
            slides[slideIndex].classList.add('active');
            
            // Highlight dot tương ứng
            if (dots[slideIndex]) {
                dots[slideIndex].classList.add('active');
            }
        }

        /**
         * Chuyển slide theo hướng (tiếp theo hoặc trước đó)
         * @param {number} direction - Hướng chuyển: 1 (tiếp) hoặc -1 (lùi)
         */
        function changeSlide(direction) {
            slideIndex += direction;
            showSlide(slideIndex);
            resetAutoSlide(); // Reset timer khi user tương tác
        }

        /**
         * Chuyển đến slide cụ thể
         * @param {number} index - Vị trí slide (bắt đầu từ 1)
         */
        function currentSlide(index) {
            slideIndex = index - 1; // Chuyển từ 1-based sang 0-based
            showSlide(slideIndex);
            resetAutoSlide();
        }

        /**
         * Bắt đầu tự động chuyển slide
         */
        function startAutoSlide() {
            autoSlideTimer = setInterval(() => {
                slideIndex++;
                showSlide(slideIndex);
            }, SLIDE_INTERVAL);
        }

        /**
         * Dừng và khởi động lại timer tự động
         * Gọi khi user click vào arrows hoặc dots
         */
        function resetAutoSlide() {
            clearInterval(autoSlideTimer);
            startAutoSlide();
        }

        /**
         * Hàm dừng slideshow (nếu cần)
         */
        function stopAutoSlide() {
            clearInterval(autoSlideTimer);
        }

        // ========================================
        // NOTIFICATION FUNCTIONS
        // ========================================
        
        /**
         * Hiển thị thông báo cho user
         * @param {string} message - Nội dung thông báo
         * @param {string} type - Loại: 'success' hoặc 'error'
         */
        function showNotification(message, type = 'success') {
            const existingNotifications = document.querySelectorAll('.notification');
            existingNotifications.forEach(notification => notification.remove());

            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <span>${message}</span>
                <span class="close-btn" onclick="this.parentElement.remove()">&times;</span>
            `;

            document.body.appendChild(notification);
            setTimeout(() => notification.classList.add('show'), 100);
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.classList.remove('show');
                    setTimeout(() => notification.remove(), 300);
                }
            }, 5000);
        }

        // Authentication functions
        function checkAuthStatus() {
            const token = localStorage.getItem('token');
            const loginBtn = document.getElementById('loginBtn');
            const userMenu = document.getElementById('userMenu');
            const userDisplayName = document.getElementById('userEmail'); // Will show user email
            
            console.log('Checking auth status. Token:', token); // Debug log
            
            if (token && token !== 'null' && token !== '') {
                // User is logged in
                if (loginBtn) loginBtn.style.display = 'none';
                if (userMenu) userMenu.style.display = 'block';
                
                // Try to get email from localStorage
                const savedEmail = localStorage.getItem('userEmail');
                if (savedEmail && userDisplayName) {
                    userDisplayName.textContent = savedEmail;
                } else if (userDisplayName) {
                    userDisplayName.textContent = 'User Account';
                }
            } else {
                // User is not logged in - Clear any invalid tokens
                localStorage.removeItem('token');
                localStorage.removeItem('userEmail');
                localStorage.removeItem('userEmail'); // Also remove old email if exists
                
                if (loginBtn) loginBtn.style.display = 'inline-block';
                if (userMenu) userMenu.style.display = 'none';
            }
        }

        function toggleUserMenu() {
            const dropdown = document.getElementById('userDropdown');
            dropdown.classList.toggle('show');
        }

        function openUserProfile() {
            // Close dropdown
            document.getElementById('userDropdown').classList.remove('show');
            
            // Check if user is logged in
            const token = localStorage.getItem('token');
            if (!token || token === 'null' || token === '') {
                showNotification('⚠️ Please login to view profile!', 'error');
                return;
            }
            
            // Navigate to user profile page
            window.location.href = 'user_profile.html';
        }

        function openBookingHistory() {
            // Close dropdown
            document.getElementById('userDropdown').classList.remove('show');
            
            // Check if user is logged in
            const token = localStorage.getItem('token');
            if (!token || token === 'null' || token === '') {
                showNotification('⚠️ Please login to view booking history!', 'error');
                return;
            }
            
            // Navigate to booking history page
            window.location.href = 'booking_history.html';
        }

        function logout() {
            // Close dropdown first
            document.getElementById('userDropdown').classList.remove('show');
            
            // Remove token and user data from localStorage
            localStorage.removeItem('token');
            localStorage.removeItem('userEmail');
            localStorage.removeItem('userEmail'); // Remove old email key if exists
            
            // Update UI
            checkAuthStatus();
            
            // Show notification
            showNotification('👋 Logged out successfully!', 'success');
            
            // Close any open modals
            closeModal();
            closeRegisterModal();
        }

        // Modal functions
        function openModal() {
            document.getElementById("modal").style.display = "flex";
        }

        function closeModal() {
            document.getElementById("modal").style.display = "none";
        }

        function openRegisterModal() {
            closeModal();
            document.getElementById("registerModal").style.display = "flex";
        }

        function closeRegisterModal() {
            document.getElementById("registerModal").style.display = "none";
        }

        function toggleMobileMenu() {
            // Mobile menu logic
        }

        // Time validation function
        function validateDateTime() {
            const pickupDate = document.getElementById('pickup-date').value;
            const pickupTime = document.getElementById('pickup-time').value;
            const returnDate = document.getElementById('return-date').value;
            const returnTime = document.getElementById('return-time').value;
            
            if (!pickupDate || !pickupTime || !returnDate || !returnTime) {
                showNotification('⚠️ Please select date and time!', 'error');
                return false;
            }
            
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const selectedPickupDate = new Date(pickupDate);
            
            const pickup = new Date(`${pickupDate}T${pickupTime}:00`);
            const returnDateTime = new Date(`${returnDate}T${returnTime}:00`);
            
            // Chỉ kiểm tra thời gian nếu pickup date là HÔM NAY
            if (selectedPickupDate.getTime() === today.getTime()) {
                // Nếu chọn ngày hôm nay, kiểm tra xem giờ đã qua chưa
                // Cho buffer 1 giờ để tránh đặt xe quá gấp
                const oneHourLater = new Date(now.getTime() + (60 * 60 * 1000));
                
                if (pickup < oneHourLater) {
                    showNotification('⏰ Pick-up time must be at least 1 hour from now!', 'error');
                    return false;
                }
            }
            // Nếu chọn ngày trong quá khứ
            else if (selectedPickupDate < today) {
                showNotification('⏰ Pick-up date cannot be in the past!', 'error');
                return false;
            }
            // Nếu chọn ngày mai hoặc sau: OK, không cần kiểm tra giờ
            
            // Check if return time is after pickup time
            if (returnDateTime <= pickup) {
                showNotification('⏰ Return time must be after pick-up time!', 'error');
                return false;
            }
            
            // Check minimum rental duration (1 hour)
            const timeDiff = returnDateTime - pickup;
            const hoursDiff = timeDiff / (1000 * 60 * 60);
            
            if (hoursDiff < 1) {
                showNotification('⏰ Minimum rental duration is 1 hour!', 'error');
                return false;
            }
            
            return true;
        }

        // ========================================
        // PAGE INITIALIZATION
        // ========================================
        
        // ========================================
        // STICKY SEARCH FORM
        // ========================================
        
        /**
         * Xử lý sticky search form khi scroll
         */
        function handleStickySearchForm() {
            const searchFormOverlay = document.getElementById('searchFormOverlay');
            const heroSlideshow = document.querySelector('.hero-slideshow');
            
            if (!searchFormOverlay || !heroSlideshow) return;
            
            window.addEventListener('scroll', function() {
                const slideshowBottom = heroSlideshow.offsetTop + heroSlideshow.offsetHeight;
                const scrollPosition = window.scrollY;
                
                // Khi scroll vượt qua slideshow, làm sticky
                if (scrollPosition >= slideshowBottom - 100) {
                    searchFormOverlay.classList.add('sticky');
                } else {
                    searchFormOverlay.classList.remove('sticky');
                }
            });
        }
        
        // ========================================
        // PAGE INITIALIZATION
        // ========================================
        
        /**
         * Khởi tạo tất cả chức năng khi trang load xong
         */
        document.addEventListener('DOMContentLoaded', function() {
            // Khởi động slideshow
            initSlideshow();
            
            // Khởi động sticky search form
            handleStickySearchForm();
            
            // Check authentication status on page load
            checkAuthStatus();
            
            // Car search form validation
            const carSearchForm = document.getElementById('car-search-form');
            if (carSearchForm) {
                carSearchForm.addEventListener('submit', function(e) {
                    if (!validateDateTime()) {
                        e.preventDefault(); // Stop form submission if validation fails
                        return false;
                    }
                    // If validation passes, form will submit normally
                });
            }
            
            // Set minimum date to today for date inputs
            const today = new Date().toISOString().split('T')[0];
            const pickupDateInput = document.getElementById('pickup-date');
            const returnDateInput = document.getElementById('return-date');
            
            if (pickupDateInput) {
                pickupDateInput.min = today;
                pickupDateInput.value = today; // Set default to today
            }
            
            if (returnDateInput) {
                returnDateInput.min = today;
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                returnDateInput.value = tomorrow.toISOString().split('T')[0]; // Set default to tomorrow
            }
            
            // Real-time validation when date/time changes
            const timeInputs = ['pickup-date', 'pickup-time', 'return-date', 'return-time'];
            timeInputs.forEach(inputId => {
                const input = document.getElementById(inputId);
                if (input) {
                    input.addEventListener('change', function() {
                        // Auto-adjust return date if pickup date is changed
                        if (inputId === 'pickup-date' && returnDateInput) {
                            const selectedDate = new Date(this.value);
                            if (returnDateInput.value <= this.value) {
                                selectedDate.setDate(selectedDate.getDate() + 1);
                                returnDateInput.value = selectedDate.toISOString().split('T')[0];
                            }
                        }
                        
                        // Show helpful hints when all fields are filled
                        const allFilled = timeInputs.every(id => document.getElementById(id).value);
                        if (allFilled) {
                            const pickup = new Date(`${document.getElementById('pickup-date').value}T${document.getElementById('pickup-time').value}`);
                            const returnDateTime = new Date(`${document.getElementById('return-date').value}T${document.getElementById('return-time').value}`);
                            const timeDiff = returnDateTime - pickup;
                            const hoursDiff = Math.round(timeDiff / (1000 * 60 * 60));
                            
                            if (hoursDiff > 0) {
                                const days = Math.floor(hoursDiff / 24);
                                const hours = hoursDiff % 24;
                                let durationText = '';
                                if (days > 0) durationText += `${days} day${days > 1 ? 's' : ''} `;
                                if (hours > 0) durationText += `${hours} hour${hours > 1 ? 's' : ''}`;
                                
                                showNotification(`✅ Rental duration: ${durationText}`, 'success');
                            }
                        }
                    });
                }
            });
            
            // Login form submit
            const loginForm = document.getElementById('loginForm');
            if (loginForm) {
                loginForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    const email = document.getElementById('loginEmail').value.trim();
                    const password = document.getElementById('loginPassword').value;
                    
                    if (!email || !password) {
                        showNotification('❌ Please enter email and password!', 'error');
                        return;
                    }
                    
                    console.log('Attempting login with email:', email);
                    
                    try {
                        const response = await window.API.login(email, password);
                        
                        console.log('Full login response:', response);
                        
                        // Lưu token và user info
                        if (response.token) {
                            localStorage.setItem('token', response.token);
                            
                            // Lưu refreshToken và tokenExpiry nếu có
                            if (response.refreshToken) {
                                localStorage.setItem('refreshToken', response.refreshToken);
                            }
                            if (response.tokenExpiry) {
                                localStorage.setItem('tokenExpiry', response.tokenExpiry);
                            }
                            
                            // Lưu userId từ response.user.id
                            if (response.user && response.user.id) {
                                localStorage.setItem('userId', response.user.id);
                                console.log('✅ Saved userId:', response.user.id);
                            }
                            
                            // Lưu thông tin user
                            if (response.user) {
                                if (response.user.name) {
                                    localStorage.setItem('username', response.user.name);
                                    console.log('✅ Saved username:', response.user.name);
                                }
                                if (response.user.email) {
                                    localStorage.setItem('userEmail', response.user.email);
                                    console.log('✅ Saved email:', response.user.email);
                                }
                                if (response.user.phoneNumber) {
                                    localStorage.setItem('userPhone', response.user.phoneNumber);
                                    console.log('✅ Saved phone:', response.user.phoneNumber);
                                }
                            }
                            
                            showNotification('🎉 Login successful! Welcome back.', 'success');
                            closeModal();
                            checkAuthStatus();
                        } else {
                            showNotification('⚠️ Invalid server response.', 'error');
                        }
                        
                    } catch (error) {
                        console.error('Login error:', error);
                        
                        let errorMessage = 'Đã xảy ra lỗi không xác định';
                        
                        if (error && typeof error === 'object') {
                            if (error.message) {
                                errorMessage = error.message;
                            } else if (error.error) {
                                errorMessage = error.error;
                            } else if (error.title) {
                                errorMessage = error.title;
                            } else if (error.errors) {
                                // Handle validation errors from API
                                const errorList = Object.values(error.errors).flat();
                                errorMessage = errorList.join(', ');
                            }
                        } else if (typeof error === 'string') {
                            errorMessage = error;
                        }
                        
                        showNotification(`❌ Login failed: ${errorMessage}`, 'error');
                    }
                });
            }

            // Register form submit
            const registerForm = document.getElementById('registerForm');
            if (registerForm) {
                registerForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    const username = document.getElementById('registerUsername').value.trim();
                    const email = document.getElementById('registerEmail').value.trim();
                    const phoneNumber = document.getElementById('registerPhone').value.trim();
                    const password = document.getElementById('registerPassword').value;
                    
                    // Basic validation
                    if (!username || !email || !phoneNumber || !password) {
                        showNotification('❌ Please fill in all information!', 'error');
                        return;
                    }
                    
                    if (username.length < 3) {
                        showNotification('❌ Username must be at least 3 characters!', 'error');
                        return;
                    }
                    
                    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                    if (!emailRegex.test(email)) {
                        showNotification('❌ Invalid email format!', 'error');
                        return;
                    }
                    
                    const phoneRegex = /^[0-9]{10,11}$/;
                    if (!phoneRegex.test(phoneNumber)) {
                        showNotification('❌ Phone number must be 10-11 digits!', 'error');
                        return;
                    }
                    
                    // Enhanced password validation for ASP.NET Identity
                    if (password.length < 6) {
                        showNotification('❌ Password must be at least 6 characters!', 'error');
                        return;
                    }
                    
                    // Check for uppercase letter
                    if (!/[A-Z]/.test(password)) {
                        showNotification('❌ Password must contain at least 1 uppercase letter (A-Z)!', 'error');
                        return;
                    }
                    
                    // Check for lowercase letter
                    if (!/[a-z]/.test(password)) {
                        showNotification('❌ Password must contain at least 1 lowercase letter (a-z)!', 'error');
                        return;
                    }
                    
                    // Check for digit
                    if (!/[0-9]/.test(password)) {
                        showNotification('❌ Password must contain at least 1 digit (0-9)!', 'error');
                        return;
                    }
                    
                    // Check for special character
                    if (!/[^A-Za-z0-9]/.test(password)) {
                        showNotification('❌ Password must contain at least 1 special character (!@#$%^&*)!', 'error');
                        return;
                    }
                    
                    console.log('Attempting register with username:', username, 'email:', email, 'phone:', phoneNumber);
                    
                    try {
                        const response = await window.API.register(username, email, phoneNumber, password);
                        
                        showNotification('🎊 Registration successful! Welcome to our system.', 'success');
                        closeRegisterModal();
                        
                        setTimeout(() => {
                            openModal();
                            showNotification('💡 You can login now!', 'success');
                        }, 2000);
                        
                    } catch (error) {
                        console.error('Register error:', error);
                        console.error('Full error object:', JSON.stringify(error, null, 2));
                        
                        let errorMessage = 'Lỗi không xác định';
                        
                        // Handle different error types
                        if (typeof error === 'string') {
                            errorMessage = error;
                        } else if (error && error.errors) {
                            // Handle validation errors (ASP.NET format)
                            const validationErrors = [];
                            for (const [field, messages] of Object.entries(error.errors)) {
                                if (Array.isArray(messages)) {
                                    validationErrors.push(`• ${field}: ${messages.join(', ')}`);
                                } else {
                                    validationErrors.push(`• ${field}: ${messages}`);
                                }
                            }
                            errorMessage = 'Lỗi validation:\n' + validationErrors.join('\n');
                        } else if (error && error.title) {
                            errorMessage = error.title;
                            if (error.errors) {
                                errorMessage += '\n' + JSON.stringify(error.errors, null, 2);
                            }
                        } else if (error && error.message) {
                            errorMessage = error.message;
                        } else if (error && error.error) {
                            errorMessage = error.error;
                        }
                        
                        showNotification(`❌ Registration failed: ${errorMessage}`, 'error');
                    }
                });
            }

            // Close dropdown when clicking outside
            document.addEventListener('click', function(event) {
                const userMenu = document.querySelector('.user-menu');
                const dropdown = document.getElementById('userDropdown');
                
                if (userMenu && !userMenu.contains(event.target)) {
                    dropdown.classList.remove('show');
                }
            });
        });
    </script>
</body>
</html>